# 議案の公開/非公開機能 要件定義書

## 1. 概要

議案管理システムにおいて、議案を「公開」「非公開」の2つのステータスで管理し、非公開の議案は管理者のみが閲覧・編集できる機能を実装する。

## 2. 目的

- 議案を公開前に準備・編集できるようにする
- 誤って未完成の議案が公開されることを防ぐ
- 議案の公開タイミングを管理者がコントロールできるようにする

## 3. 機能要件

### 3.1 データ管理

#### 3.1.1 データベース変更
- `bills`テーブルに`status`カラムを追加
  - 型: `bill_status` (ENUM型)
  - デフォルト値: `'draft'`
  - NOT NULL制約

#### 3.1.2 ステータス定義
```typescript
type BillStatus = 'published' | 'draft';
```

### 3.2 管理画面（Admin）機能

#### 3.2.1 議案一覧画面
- すべての議案を表示（公開/非公開両方）
- ステータスバッジ表示
  - 公開: 緑色のバッジ「公開中」
  - 非公開: 灰色のバッジ「下書き」

#### 3.2.2 議案編集画面
- ステータス切り替えボタン
  - 「公開する」ボタン（下書き→公開）
  - 「下書きに戻す」ボタン（公開→下書き）
- 現在のステータス表示
- プレビューボタン（非公開議案も確認可能）

#### 3.2.3 新規作成時
- デフォルトで「下書き」ステータス
- 作成と同時に公開するオプション

### 3.3 公開サイト（Web）機能

#### 3.3.1 議案一覧
- 公開ステータスの議案のみ表示
- 非公開議案は完全に非表示

#### 3.3.2 議案詳細
- 公開ステータスの議案のみアクセス可能
- 非公開議案にアクセスした場合は404エラー

### 3.4 プレビュー機能

#### 3.4.1 プレビューURL
- webプロジェクト側に専用のプレビューページを作成
- 例: `/preview/bills/{id}`
- プレビュー専用のトークンまたはクエリパラメータで認証
  - 例: `/preview/bills/{id}?token=xxx`
- 管理画面からプレビューURLをワンクリックで開く

#### 3.4.2 プレビュー表示
- 公開サイトと完全に同じコンポーネント・スタイルを使用
- 「プレビューモード」であることを明示
  - ページ上部に固定の警告バナー表示
  - 「このページはプレビューです。一般公開されていません」
- 管理画面へ戻るリンクを配置

## 4. 非機能要件

### 4.1 セキュリティ
- 非公開議案へのアクセスは管理者権限が必要
- プレビューURLは一時的なトークンで保護
  - トークンの有効期限：30日
  - URLを知っている人のみアクセス可能（共有しやすくするため）

### 4.2 パフォーマンス
- ステータスによるフィルタリングはインデックスを使用
- 一覧表示時のクエリ最適化

### 4.3 運用性
- ステータス変更時のログ記録
- 誤操作防止のための確認ダイアログ

## 5. 画面設計

### 5.1 議案一覧画面（管理）
```
┌─────────────────────────────────────┐
│ 議案一覧                    [新規作成] │
├─────────────────────────────────────┤
│ ┌─────────────────────────────┐    │
│ │ 第213号議案 [公開中]         │    │
│ │ 2024/12/01 公開              │    │
│ │ [編集] [プレビュー] [下書きに] │   │
│ └─────────────────────────────┘    │
│ ┌─────────────────────────────┐    │
│ │ 第214号議案 [下書き]         │    │
│ │ 未公開                       │    │
│ │ [編集] [プレビュー] [公開する] │   │
│ └─────────────────────────────┘    │
└─────────────────────────────────────┘
```

### 5.2 議案編集画面
```
┌─────────────────────────────────────┐
│ 議案編集                             │
│ ステータス: [下書き] ← 現在の状態    │
├─────────────────────────────────────┤
│ [議案情報入力フォーム]               │
│                                      │
│ [保存] [プレビュー] [公開する]       │
└─────────────────────────────────────┘
```

## 6. Server Actions設計

### 6.1 議案取得（Server Components）
```typescript
// 管理画面用（全議案取得）
// app/admin/bills/page.tsx
async function BillsPage() {
  const bills = await getBills({ includeUnpublished: true });
}

// 公開サイト用（公開議案のみ）
// app/bills/page.tsx
async function PublicBillsPage() {
  const bills = await getBills({ includeUnpublished: false });
}
```

### 6.2 ステータス変更（Server Actions）
```typescript
// app/admin/bills/actions.ts
"use server";

export async function updateBillStatus(
  billId: string,
  status: 'published' | 'draft'
) {
  // 認証チェック
  // Supabaseでステータス更新
  // revalidatePath('/admin/bills')
}
```

### 6.3 プレビュー
```typescript
// 管理画面側（プレビューURL生成）
// app/admin/bills/actions.ts
"use server";

export async function generatePreviewUrl(billId: string) {
  // トークン生成
  // Supabaseにトークン保存
  return {
    url: `${process.env.NEXT_PUBLIC_WEB_URL}/preview/bills/${billId}?token=${token}`,
    token,
    expiresAt: // 30日後
  };
}

// webプロジェクト側（プレビューページ）
// app/preview/bills/[id]/page.tsx
export async function PreviewBillPage({ params, searchParams }) {
  const isValidToken = await validatePreviewToken(params.id, searchParams.token);
  if (!isValidToken) {
    notFound();
  }
  const bill = await getBillById(params.id, { includeUnpublished: true });
  // プレビュー表示
}
```

## 7. データベースマイグレーション

```sql
-- ENUM型を作成
CREATE TYPE bill_status AS ENUM ('draft', 'published');

-- ステータスカラムを追加
ALTER TABLE bills
ADD COLUMN status bill_status NOT NULL DEFAULT 'draft';

-- インデックスを追加
CREATE INDEX idx_bills_status ON bills(status);

-- 既存データを公開済みに更新
UPDATE bills SET status = 'published';
```

## 8. 実装順序

1. データベースマイグレーション実行
2. 型定義の追加
3. 公開サイト側のフィルタリング修正（publishedのみ表示）
4. 管理画面の議案一覧にステータス表示追加
5. ステータス切り替え機能の実装
6. webプロジェクトにプレビューページ実装
7. 管理画面からプレビューURLを開く機能

## 9. テスト項目

### 9.1 単体テスト
- ステータス変更API
- フィルタリングロジック

### 9.2 統合テスト
- 非公開議案が公開サイトに表示されないこと
- プレビュー機能が正しく動作すること
- ステータス変更が正しく反映されること

### 9.3 E2Eテスト
- 議案作成→下書き保存→プレビュー→公開の一連の流れ
- 公開議案を下書きに戻す操作

## 10. 今後の拡張可能性

- スケジュール公開機能
- 承認フロー機能
- バージョン管理機能
- 下書きの自動保存機能

---
作成日: 2025/09/22 18:26
作成者: Claude