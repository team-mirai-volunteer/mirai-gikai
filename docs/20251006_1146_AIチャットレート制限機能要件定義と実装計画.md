# AIãƒãƒ£ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆåˆ¶é™æ©Ÿèƒ½ è¦ä»¶å®šç¾©ã¨å®Ÿè£…è¨ˆç”»

## ğŸ“‹ è¦ä»¶å®šç¾©

### 1. èƒŒæ™¯ã¨ç›®çš„

#### 1.1 èƒŒæ™¯
ç¾åœ¨ã€AIãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã¯èªè¨¼ä¸è¦ã§èª°ã§ã‚‚åˆ©ç”¨å¯èƒ½ãªçŠ¶æ…‹ã§ã‚ã‚Šã€ä»¥ä¸‹ã®èª²é¡ŒãŒå­˜åœ¨ã™ã‚‹ï¼š
- APIä½¿ç”¨é‡ã®ä¸Šé™ç®¡ç†ãŒã§ããªã„
- ã‚³ã‚¹ãƒˆå¢—åŠ ã®ãƒªã‚¹ã‚¯
- æ‚ªæ„ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹å¤§é‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å¯èƒ½æ€§

#### 1.2 ç›®çš„
åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚‚AIãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã‚’åˆ©ç”¨ã§ãã‚‹çŠ¶æ…‹ã‚’ç¶­æŒã—ã¤ã¤ã€é©åˆ‡ãªä½¿ç”¨é‡åˆ¶é™ã‚’è¨­ã‘ã‚‹ã“ã¨ã§ã‚³ã‚¹ãƒˆã‚’ç®¡ç†ã—ã€ã‚µãƒ¼ãƒ“ã‚¹ã®æŒç¶šå¯èƒ½æ€§ã‚’ç¢ºä¿ã™ã‚‹ã€‚

#### 1.3 è¨­è¨ˆæ€æƒ³
- **ã‚·ãƒ³ãƒ—ãƒ«ç¬¬ä¸€**: åˆæœŸå®Ÿè£…ã§ã¯æœ€å°é™ã®æ©Ÿèƒ½ã«çµã‚‹
- **æ®µéšçš„åˆ¶é™**: å®Œå…¨ãªãƒœãƒƒãƒˆå¯¾ç­–ã§ã¯ãªãã€é€šå¸¸ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆ©ä¾¿æ€§ã‚’æãªã‚ãªã„ç¯„å›²ã§ã®åˆ¶é™
- **å°†æ¥ã®æ‹¡å¼µæ€§**: èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼æ©Ÿèƒ½ã¸ã®ç§»è¡Œã‚’è¦‹æ®ãˆãŸè¨­è¨ˆ

### 2. æ©Ÿèƒ½è¦ä»¶

#### 2.1 åŒ¿åèªè¨¼æ©Ÿèƒ½
- **Supabase Anonymous Auth ã®åˆ©ç”¨**
  - åˆå›è¨ªå•æ™‚ã«åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è‡ªå‹•ä½œæˆ
  - åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’Supabaseã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ç®¡ç†
  - ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ä¿å­˜

#### 2.2 ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ç®¡ç†
- **ä½¿ç”¨é‡ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°**
  - å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§è¨˜éŒ²
  - å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³ + å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³ã®åˆè¨ˆã‚’è¨˜éŒ²
  - ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã”ã¨ã«ä½¿ç”¨é‡ã‚’æ›´æ–°

- **ä½¿ç”¨åˆ¶é™**
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ç”Ÿæ¶¯ãƒˆãƒ¼ã‚¯ãƒ³ä¸Šé™: 10,000ãƒˆãƒ¼ã‚¯ãƒ³
  - ä¸Šé™åˆ°é”å¾Œã¯ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–
  - ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ãªã—ï¼ˆåˆæœŸå®Ÿè£…ã§ã¯ï¼‰

#### 2.3 åˆ¶é™åˆ°é”æ™‚ã®å‹•ä½œ
- ãƒãƒ£ãƒƒãƒˆå…¥åŠ›æ¬„ã‚’ç„¡åŠ¹åŒ–
- åˆ¶é™åˆ°é”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
- å°†æ¥çš„ãªæ­£å¼ç™»éŒ²ã¸ã®èª˜å°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

#### 2.4 ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
- **Cookie/LocalStorage ã«ã‚ˆã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³æ°¸ç¶šåŒ–**
  - ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦ã‚‚åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ä¿æŒ
  - Supabaseã®æ¨™æº–ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†æ©Ÿèƒ½ã‚’åˆ©ç”¨

- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢æ™‚ã®å‹•ä½œ**
  - æ–°ã—ã„åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦æ‰±ã†
  - æ–°ãŸã«10,000ãƒˆãƒ¼ã‚¯ãƒ³ã®ä¸Šé™ã‚’ä»˜ä¸
  - éå»ã®ä½¿ç”¨å±¥æ­´ã¨ã¯ç´ã¥ã‹ãªã„

### 3. éæ©Ÿèƒ½è¦ä»¶

#### 3.1 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ãƒã‚§ãƒƒã‚¯: 100msä»¥å†…
- åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ: 500msä»¥å†…
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°: éåŒæœŸå‡¦ç†ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã«å½±éŸ¿ã—ãªã„ï¼‰

#### 3.2 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- **åˆæœŸå®Ÿè£…ã§å¯¾å¿œã—ãªã„ã“ã¨**
  - IP ãƒ™ãƒ¼ã‚¹ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™
  - ãƒªã‚¯ã‚¨ã‚¹ãƒˆé »åº¦åˆ¶é™
  - é«˜åº¦ãªãƒœãƒƒãƒˆæ¤œçŸ¥

- **è¨±å®¹ã™ã‚‹ãƒªã‚¹ã‚¯**
  - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã«ã‚ˆã‚‹ä¸Šé™ãƒªã‚»ãƒƒãƒˆ
  - å˜ç´”ãªcurlãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚ˆã‚‹æ‚ªç”¨

#### 3.3 ãƒ‡ãƒ¼ã‚¿ä¿æŒ
- åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨å±¥æ­´ã¯æ°¸ç¶šçš„ã«ä¿å­˜
- å®šæœŸçš„ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã¯å®Ÿè£…ã—ãªã„ï¼ˆåˆæœŸç‰ˆï¼‰

### 4. åˆ¶ç´„äº‹é …

#### 4.1 åˆæœŸå®Ÿè£…ã®åˆ¶ç´„
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™æ©Ÿèƒ½ã¯å®Ÿè£…ã—ãªã„
- IPåˆ¶é™ã¯å®Ÿè£…ã—ãªã„
- è¤‡é›‘ãªãƒœãƒƒãƒˆå¯¾ç­–ã¯å®Ÿè£…ã—ãªã„
- ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ã¯å®Ÿè£…ã—ãªã„

#### 4.2 å°†æ¥ã®æ‹¡å¼µã§å¯¾å¿œã™ã‚‹æ©Ÿèƒ½
- èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ç§»è¡Œæ™‚ã®ãƒˆãƒ¼ã‚¯ãƒ³å¼•ãç¶™ã
- ã‚ˆã‚Šå®‰ä¾¡ãªãƒ¢ãƒ‡ãƒ«ã¸ã®è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆ
- IP ãƒ™ãƒ¼ã‚¹ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å˜ä½ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆé »åº¦åˆ¶é™

## ğŸ—ï¸ å®Ÿè£…è¨ˆç”»

### Phase 1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆã¨ä½œæˆ

#### 1.1 æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«: `user_token_usage`

```sql
CREATE TABLE user_token_usage (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    token_used INTEGER NOT NULL DEFAULT 0,
    token_limit INTEGER NOT NULL DEFAULT 10000,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    CONSTRAINT unique_user_id UNIQUE(user_id)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_user_token_usage_user_id ON user_token_usage(user_id);
CREATE INDEX idx_user_token_usage_token_used ON user_token_usage(token_used);

-- updated_atè‡ªå‹•æ›´æ–°ãƒˆãƒªã‚¬ãƒ¼
CREATE TRIGGER update_user_token_usage_updated_at
    BEFORE UPDATE ON user_token_usage
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

#### 1.2 RLS ãƒãƒªã‚·ãƒ¼

```sql
-- RLSæœ‰åŠ¹åŒ–
ALTER TABLE user_token_usage ENABLE ROW LEVEL SECURITY;

-- ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å…¨ç¦æ­¢ï¼‰
-- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã¯è¨±å¯ã—ãªã„
```

### Phase 2: åŒ¿åèªè¨¼æ©Ÿèƒ½ã®å®Ÿè£…

#### 2.1 ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
web/src/
â”œâ”€â”€ features/
â”‚   â””â”€â”€ auth/
â”‚       â”œâ”€â”€ actions/
â”‚       â”‚   â””â”€â”€ anonymous-auth.ts       # åŒ¿åèªè¨¼Server Action
â”‚       â”œâ”€â”€ hooks/
â”‚       â”‚   â””â”€â”€ use-anonymous-auth.ts   # åŒ¿åèªè¨¼ãƒ•ãƒƒã‚¯
â”‚       â””â”€â”€ types/
â”‚           â””â”€â”€ index.ts
â””â”€â”€ lib/
    â””â”€â”€ supabase/
        â””â”€â”€ client.ts                    # Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
```

#### 2.2 åŒ¿åèªè¨¼å®Ÿè£…

```typescript
// features/auth/actions/anonymous-auth.ts
"use server";

import { createClient } from "@/lib/supabase/server";

export async function ensureAnonymousUser() {
  const supabase = await createClient();

  // æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
  const { data: { session } } = await supabase.auth.getSession();

  if (session) {
    return { userId: session.user.id, isNew: false };
  }

  // åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
  const { data, error } = await supabase.auth.signInAnonymously();

  if (error) {
    throw new Error(`Anonymous auth failed: ${error.message}`);
  }

  // user_token_usageãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ
  await initializeUserTokenUsage(data.user.id);

  return { userId: data.user.id, isNew: true };
}

async function initializeUserTokenUsage(userId: string) {
  const supabase = await createClient();

  const { error } = await supabase
    .from("user_token_usage")
    .insert({
      user_id: userId,
      token_used: 0,
      token_limit: 10000,
    });

  if (error) {
    console.error("Failed to initialize token usage:", error);
  }
}
```

```typescript
// features/auth/hooks/use-anonymous-auth.ts
"use client";

import { useEffect, useState } from "react";
import { ensureAnonymousUser } from "../actions/anonymous-auth";

export function useAnonymousAuth() {
  const [userId, setUserId] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    async function init() {
      try {
        const { userId } = await ensureAnonymousUser();
        setUserId(userId);
      } catch (error) {
        console.error("Anonymous auth error:", error);
      } finally {
        setIsLoading(false);
      }
    }

    init();
  }, []);

  return { userId, isLoading };
}
```

### Phase 3: ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ç®¡ç†æ©Ÿèƒ½

#### 3.1 ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½

```typescript
// features/chat/actions/check-token-limit.ts
"use server";

import { createClient } from "@/lib/supabase/server";

export async function checkTokenLimit(userId: string) {
  const supabase = await createClient();

  const { data, error } = await supabase
    .from("user_token_usage")
    .select("token_used, token_limit")
    .eq("user_id", userId)
    .single();

  if (error || !data) {
    return { canUse: false, remaining: 0, error: "Failed to fetch token usage" };
  }

  const remaining = data.token_limit - data.token_used;
  const canUse = remaining > 0;

  return { canUse, remaining, tokenUsed: data.token_used, tokenLimit: data.token_limit };
}
```

#### 3.2 ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡æ›´æ–°æ©Ÿèƒ½

```typescript
// features/chat/actions/update-token-usage.ts
"use server";

import { createClient } from "@/lib/supabase/server";

export async function updateTokenUsage(
  userId: string,
  inputTokens: number,
  outputTokens: number
) {
  const supabase = await createClient();

  const totalTokens = inputTokens + outputTokens;

  // ç¾åœ¨ã®ä½¿ç”¨é‡ã‚’å–å¾—
  const { data: current } = await supabase
    .from("user_token_usage")
    .select("token_used")
    .eq("user_id", userId)
    .single();

  if (!current) {
    throw new Error("User token usage not found");
  }

  // ä½¿ç”¨é‡ã‚’æ›´æ–°
  const { error } = await supabase
    .from("user_token_usage")
    .update({
      token_used: current.token_used + totalTokens
    })
    .eq("user_id", userId);

  if (error) {
    console.error("Failed to update token usage:", error);
    throw error;
  }

  return { success: true, tokensAdded: totalTokens };
}
```

### Phase 4: ãƒãƒ£ãƒƒãƒˆAPIçµ±åˆ

#### 4.1 æ—¢å­˜ãƒãƒ£ãƒƒãƒˆAPIã®ä¿®æ­£

```typescript
// app/api/chat/route.ts
import { streamText } from "ai";
import { createClient } from "@/lib/supabase/server";
import { checkTokenLimit } from "@/features/chat/actions/check-token-limit";
import { updateTokenUsage } from "@/features/chat/actions/update-token-usage";

export async function POST(req: Request) {
  const { messages, billContext } = await req.json();

  // åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
  const supabase = await createClient();
  const { data: { session } } = await supabase.auth.getSession();

  if (!session) {
    return new Response("Unauthorized", { status: 401 });
  }

  const userId = session.user.id;

  // ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ãƒã‚§ãƒƒã‚¯
  const { canUse, remaining } = await checkTokenLimit(userId);

  if (!canUse) {
    return new Response(
      JSON.stringify({
        error: "Token limit reached",
        message: "ãƒˆãƒ¼ã‚¯ãƒ³ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚"
      }),
      {
        status: 429,
        headers: { "Content-Type": "application/json" }
      }
    );
  }

  const systemPrompt = `
    ã‚ãªãŸã¯æ—¥æœ¬ã®è­°æ¡ˆã«ã¤ã„ã¦èª¬æ˜ã™ã‚‹å°‚é–€çš„ãªã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚

    è­°æ¡ˆæƒ…å ±ï¼š
    - åç§°: ${billContext.name}
    - èª¬æ˜: ${billContext.description || ""}
    - è©³ç´°: ${billContext.content || ""}
    - ãƒãƒ¼ãƒ ã¿ã‚‰ã„ã®ã‚¹ã‚¿ãƒ³ã‚¹: ${billContext.miraiStance?.position || ""}
      ç†ç”±: ${billContext.miraiStance?.reason || ""}

    ãƒ«ãƒ¼ãƒ«ï¼š
    1. ã“ã®è­°æ¡ˆã«é–¢ã™ã‚‹è³ªå•ã«ã®ã¿å›ç­”ã™ã‚‹
    2. åˆ†ã‹ã‚Šã‚„ã™ãç°¡æ½”ã«èª¬æ˜ã™ã‚‹
    3. å°‚é–€ç”¨èªã¯å¿…è¦ã«å¿œã˜ã¦è§£èª¬ã™ã‚‹
    4. è­°æ¡ˆã¨ç„¡é–¢ä¿‚ã®è³ªå•ã«ã¯ã€Œç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã“ã®è­°æ¡ˆã«é–¢ã™ã‚‹è³ªå•ã«ãŠç­”ãˆã—ã¾ã™ã€ã¨è¿”ç­”ã™ã‚‹
  `;

  const result = streamText({
    model: "openai/gpt-4o-mini",
    system: systemPrompt,
    messages,
    apiKey: process.env.AI_GATEWAY_API_KEY,
    onFinish: async ({ usage }) => {
      // ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã‚’è¨˜éŒ²ï¼ˆéåŒæœŸï¼‰
      if (usage) {
        await updateTokenUsage(
          userId,
          usage.promptTokens,
          usage.completionTokens
        );
      }
    },
  });

  return result.toDataStreamResponse();
}
```

### Phase 5: UIå®Ÿè£…

#### 5.1 ãƒãƒ£ãƒƒãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ä¿®æ­£

```typescript
// features/chat/components/chat-window.tsx
"use client";

import { useChat } from "ai/react";
import { useEffect, useState } from "react";
import { useAnonymousAuth } from "@/features/auth/hooks/use-anonymous-auth";
import { checkTokenLimit } from "@/features/chat/actions/check-token-limit";

export function ChatWindow({ billContext, onClose }: ChatWindowProps) {
  const { userId, isLoading: authLoading } = useAnonymousAuth();
  const [tokenInfo, setTokenInfo] = useState<{
    canUse: boolean;
    remaining: number;
    tokenUsed: number;
    tokenLimit: number;
  } | null>(null);

  useEffect(() => {
    async function fetchTokenInfo() {
      if (!userId) return;

      const info = await checkTokenLimit(userId);
      setTokenInfo(info);
    }

    fetchTokenInfo();
  }, [userId]);

  const { messages, input, handleInputChange, handleSubmit, isLoading } =
    useChat({
      api: "/api/chat",
      body: {
        billContext,
      },
      initialMessages: [
        {
          id: "welcome",
          role: "assistant",
          content: `ã“ã‚“ã«ã¡ã¯ï¼ã€Œ${billContext.name}ã€ã«ã¤ã„ã¦ã€ã”è³ªå•ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãªè³ªå•ã«ãŠç­”ãˆã§ãã¾ã™ï¼š
- ã“ã®è­°æ¡ˆã®ç›®çš„ã¯ä½•ã§ã™ã‹ï¼Ÿ
- ã©ã®ã‚ˆã†ãªå½±éŸ¿ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ
- ã¿ã‚‰ã„ã¯ãªãœã“ã®ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–ã£ã¦ã„ã‚‹ã®ã§ã™ã‹ï¼Ÿ

ãŠæ°—è»½ã«ã”è³ªå•ãã ã•ã„ã€‚`,
        },
      ],
    });

  const isInputDisabled = !tokenInfo?.canUse || isLoading || authLoading;

  return (
    <div className="fixed inset-x-0 bottom-0 z-50 h-[70vh] bg-background shadow-xl md:bottom-4 md:right-4 md:left-auto md:h-[600px] md:w-[400px] md:rounded-lg flex flex-col">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="flex items-center justify-between border-b p-4">
        <h2 className="text-lg font-semibold">è­°æ¡ˆã«ã¤ã„ã¦è³ªå•ã™ã‚‹</h2>
        <button
          onClick={onClose}
          className="rounded-full p-1 hover:bg-gray-100"
          aria-label="é–‰ã˜ã‚‹"
        >
          <X className="h-5 w-5" />
        </button>
      </div>

      {/* ãƒˆãƒ¼ã‚¯ãƒ³æ®‹é‡è¡¨ç¤º */}
      {tokenInfo && (
        <div className="border-b px-4 py-2 text-sm text-gray-600">
          æ®‹ã‚Šãƒˆãƒ¼ã‚¯ãƒ³: {tokenInfo.remaining.toLocaleString()} / {tokenInfo.tokenLimit.toLocaleString()}
        </div>
      )}

      {/* åˆ¶é™åˆ°é”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */}
      {tokenInfo && !tokenInfo.canUse && (
        <div className="bg-yellow-50 border-b px-4 py-3 text-sm text-yellow-800">
          ãƒˆãƒ¼ã‚¯ãƒ³ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã›ã‚“ã€‚
        </div>
      )}

      {/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ */}
      <Conversation className="flex-1 overflow-y-auto p-4">
        {messages.map((message) => (
          <Message
            key={message.id}
            role={message.role}
            className={`mb-4 ${
              message.role === "user" ? "justify-end" : "justify-start"
            }`}
          >
            {message.role === "assistant" ? (
              <StreamdownMessage content={message.content} />
            ) : (
              message.content
            )}
          </Message>
        ))}
        {isLoading && <Loader />}
      </Conversation>

      {/* å…¥åŠ›ã‚¨ãƒªã‚¢ */}
      <div className="border-t p-4">
        <PromptInput
          value={input}
          onChange={handleInputChange}
          onSubmit={handleSubmit}
          placeholder={
            isInputDisabled
              ? "ãƒãƒ£ãƒƒãƒˆã¯åˆ©ç”¨ã§ãã¾ã›ã‚“"
              : "è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
          }
          disabled={isInputDisabled}
        />
      </div>
    </div>
  );
}
```

#### 5.2 ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ä¿®æ­£

```typescript
// features/chat/components/chat-button.tsx
"use client";

import { MessageCircle } from "lucide-react";
import { useState } from "react";
import { ChatWindow } from "./chat-window";
import { useAnonymousAuth } from "@/features/auth/hooks/use-anonymous-auth";

export function ChatButton({ billContext }: ChatButtonProps) {
  const [isOpen, setIsOpen] = useState(false);
  const { userId, isLoading } = useAnonymousAuth();

  if (isLoading) {
    return null; // ã¾ãŸã¯èª­ã¿è¾¼ã¿ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
  }

  return (
    <>
      <button
        onClick={() => setIsOpen(true)}
        className="fixed bottom-4 right-4 z-50 rounded-full bg-primary p-4 text-white shadow-lg hover:bg-primary/90 transition-colors md:bottom-8 md:right-8"
        aria-label="è­°æ¡ˆã«ã¤ã„ã¦è³ªå•ã™ã‚‹"
      >
        <MessageCircle className="h-6 w-6" />
      </button>

      {isOpen && (
        <ChatWindow
          billContext={billContext}
          onClose={() => setIsOpen(false)}
        />
      )}
    </>
  );
}
```

### Phase 6: ãƒ†ã‚¹ãƒˆã¨ãƒ‡ãƒãƒƒã‚°

#### 6.1 å˜ä½“ãƒ†ã‚¹ãƒˆé …ç›®
- [ ] åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
- [ ] ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã®è¨˜éŒ²ãŒæ­£ç¢º
- [ ] ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ãƒã‚§ãƒƒã‚¯ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
- [ ] åˆ¶é™åˆ°é”æ™‚ã«ãƒãƒ£ãƒƒãƒˆé€ä¿¡ãŒç„¡åŠ¹åŒ–ã•ã‚Œã‚‹

#### 6.2 çµ±åˆãƒ†ã‚¹ãƒˆé …ç›®
- [ ] åˆå›è¨ªå•æ™‚ã«åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªå‹•ä½œæˆã•ã‚Œã‚‹
- [ ] ãƒãƒ£ãƒƒãƒˆé€ä¿¡å¾Œã«ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ãŒæ›´æ–°ã•ã‚Œã‚‹
- [ ] 10,000ãƒˆãƒ¼ã‚¯ãƒ³åˆ°é”å¾Œã«åˆ¶é™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒ–ãƒ©ã‚¦ã‚¶ãƒªãƒ­ãƒ¼ãƒ‰å¾Œã‚‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç¶­æŒã•ã‚Œã‚‹
- [ ] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å¾Œã«æ–°ã—ã„åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹

#### 6.3 æ‰‹å‹•ãƒ†ã‚¹ãƒˆé …ç›®
- [ ] è¤‡æ•°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ãƒˆãƒ¼ã‚¯ãƒ³ãŒç´¯ç©ã•ã‚Œã‚‹
- [ ] æ®‹ã‚Šãƒˆãƒ¼ã‚¯ãƒ³è¡¨ç¤ºãŒæ­£ç¢º
- [ ] åˆ¶é™åˆ°é”æ™‚ã®UIè¡¨ç¤ºãŒé©åˆ‡
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒé©åˆ‡

## ğŸ“Š å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

### Phase 1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æº–å‚™ï¼ˆ30åˆ†ï¼‰
- ã‚¹ã‚­ãƒ¼ãƒä½œæˆ
- RLSãƒãƒªã‚·ãƒ¼è¨­å®š
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

### Phase 2: åŒ¿åèªè¨¼å®Ÿè£…ï¼ˆ1æ™‚é–“ï¼‰
- Server Actionå®Ÿè£…
- ãƒ•ãƒƒã‚¯å®Ÿè£…
- åŸºæœ¬çš„ãªå‹•ä½œç¢ºèª

### Phase 3: ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†æ©Ÿèƒ½ï¼ˆ1.5æ™‚é–“ï¼‰
- ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½å®Ÿè£…
- æ›´æ–°æ©Ÿèƒ½å®Ÿè£…
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### Phase 4: APIçµ±åˆï¼ˆ1æ™‚é–“ï¼‰
- ãƒãƒ£ãƒƒãƒˆAPIä¿®æ­£
- ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡è¨˜éŒ²
- åˆ¶é™ãƒã‚§ãƒƒã‚¯çµ±åˆ

### Phase 5: UIå®Ÿè£…ï¼ˆ2æ™‚é–“ï¼‰
- ãƒãƒ£ãƒƒãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ä¿®æ­£
- æ®‹é‡è¡¨ç¤ºå®Ÿè£…
- åˆ¶é™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º

### Phase 6: ãƒ†ã‚¹ãƒˆï¼ˆ1æ™‚é–“ï¼‰
- å˜ä½“ãƒ†ã‚¹ãƒˆ
- çµ±åˆãƒ†ã‚¹ãƒˆ
- æ‰‹å‹•ãƒ†ã‚¹ãƒˆ

**åˆè¨ˆè¦‹ç©ã‚‚ã‚Šæ™‚é–“**: ç´„7æ™‚é–“

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### ç¾åœ¨ã®åˆ¶ç´„ã¨å—å®¹ã™ã‚‹ãƒªã‚¹ã‚¯
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã«ã‚ˆã‚‹ä¸Šé™ãƒªã‚»ãƒƒãƒˆ**: è¨±å®¹ã™ã‚‹
- **å˜ç´”ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã‚ˆã‚‹æ‚ªç”¨**: éƒ¨åˆ†çš„ã«è¨±å®¹ã™ã‚‹
- **IPåˆ¶é™ãªã—**: åˆæœŸå®Ÿè£…ã§ã¯å¯¾å¿œã—ãªã„

### å°†æ¥ã®æ”¹å–„æ¡ˆ
- Cloudflare Turnstileãªã©ã®ãƒœãƒƒãƒˆå¯¾ç­–
- IPå˜ä½ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™
- ãƒ‡ãƒã‚¤ã‚¹ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆ
- ã‚ˆã‚Šé«˜åº¦ãªç•°å¸¸æ¤œçŸ¥

## ğŸ“ˆ æˆåŠŸæŒ‡æ¨™

### å®šé‡çš„æŒ‡æ¨™
- 1æ—¥ã‚ãŸã‚Šã®ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ãŒæƒ³å®šç¯„å›²å†…ï¼ˆä¾‹: 1æ—¥100ä¸‡ãƒˆãƒ¼ã‚¯ãƒ³ä»¥å†…ï¼‰
- åˆ¶é™åˆ°é”ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‰²åˆãŒ10%ä»¥ä¸‹
- API ã‚¨ãƒ©ãƒ¼ç‡ãŒ1%ä»¥ä¸‹

### å®šæ€§çš„æŒ‡æ¨™
- é€šå¸¸ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½“é¨“ãŒæãªã‚ã‚Œãªã„
- ã‚³ã‚¹ãƒˆç®¡ç†ãŒå¯èƒ½ã«ãªã‚‹
- æ˜ã‚‰ã‹ãªæ‚ªç”¨ãŒé˜²æ­¢ã§ãã‚‹

## ğŸ“š å‚è€ƒè³‡æ–™

- [Supabase Anonymous Auth](https://supabase.com/docs/guides/auth/auth-anonymous)
- [Vercel AI SDK Usage Tracking](https://sdk.vercel.ai/docs/ai-sdk-core/usage)
- [Next.js Server Actions](https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations)
