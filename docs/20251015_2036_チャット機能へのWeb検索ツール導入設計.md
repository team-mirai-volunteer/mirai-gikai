# チャット機能へのWeb検索ツール導入設計

## 概要

現在の `handle-chat-request.ts` では Vercel AI SDK を使って gpt-4o-mini で返答を返しているが、LLMの知識カットオフ以降の情報や特定の最新情報については適切な回答ができない。この問題を解決するため、Web検索ツールを導入し、必要に応じて最新情報を取得できるようにする。

## 調査結果

### 1. Agent向け検索ツールの比較（2025年時点）

| サービス | 特徴 | レイテンシ | 価格 | ユースケース |
|---------|------|-----------|------|------------|
| **Tavily** | LLM向けに最適化されたJSON構造、サマリー・引用含む | 中程度 | 月1,000クレジット無料<br>Basic Search: 1credit/req<br>Advanced: 2credit/req | 構造化されたデータが必要な場合 |
| **Perplexity API** | 超高速（中央値358ms）、ランク付けされた結果 | 最速 | $5/1,000リクエスト | 高頻度・低レイテンシが必要 |
| **Exa** | 埋め込みベースの意味理解、コンテキスト重視 | 中程度 | 従量課金 | 意味的理解が重要な場合 |
| **OpenAI Native Search** | gpt-4o-search-preview 組み込み | 速い | OpenAI料金に含まれる | OpenAI エコシステム内で完結 |

### 2. Vercel AI SDKでの実装アプローチ

#### A. Native Search（モデル組み込み）
- **OpenAI gpt-4o-search-preview**: `web_search_preview` ツールが組み込み
- **Perplexity Sonar モデル**: リアルタイムWeb検索がネイティブ統合
- **利点**: 追加実装が最小限、レイテンシ最小
- **欠点**: プロバイダー依存、カスタマイズ不可

#### B. Custom Tool（カスタムツール）
```typescript
import { tool } from 'ai';
import { z } from 'zod';

const webSearch = tool({
  description: '最新情報を検索するために使用',
  inputSchema: z.object({
    query: z.string().min(1).max(100)
  }),
  execute: async ({ query }) => {
    // Tavily/Exa/Perplexity APIを呼び出し
    return results;
  }
});
```

- **利点**: 柔軟性が高い、プロバイダー切り替え可能、任意のLLMで使用可
- **欠点**: 実装コスト増、追加のAPI料金

### 3. Vercel AI SDK Agent実装の基本

```typescript
import { streamText, generateText, tool } from 'ai';
import { stopWhen, stepCountIs } from 'ai/agent';

// Multi-step reasoning with tools
const result = await streamText({
  model: yourModel,
  system: 'システムプロンプト',
  messages: convertToModelMessages(messages),
  tools: {
    webSearch: webSearchTool,
    // 他のツール
  },
  maxSteps: 5, // 最大ステップ数
  experimental_telemetry: {
    // テレメトリ設定
  }
});
```

**動作フロー:**
1. LLMがユーザー入力を解釈
2. 必要に応じてツールを選択
3. ツールを実行し結果を取得
4. 結果をコンテキストに追加して再度LLMに送信
5. 最終回答を生成

## 推奨実装方針

### アプローチ選択

**Tavily + Custom Tool を推奨**

理由：
1. **無料枠が十分**: 月1,000クレジット（1,000リクエスト相当）で実験・スモールスケール運用可能
2. **LLM最適化**: JSON構造化データ、サマリー付きでLLMが処理しやすい
3. **プロバイダー非依存**: 任意のLLMで使用可能、将来的なモデル変更に強い
4. **実装コスト小**: シンプルなREST API、Vercel AI SDKの `tool()` で簡単に統合

### モデル選択

**現状の gpt-4o-mini を維持、または gpt-4o に変更を検討**

- **gpt-4o-mini**: Tool callingは可能だが精度は劣る
- **gpt-4o**: より高精度なtool calling、agenticタスクに適している
- **代替案**: DeepSeek V3.1 はコスト効率が良くtool calling対応

**今回はテスト実装のため gpt-4o-mini で開始し、必要に応じて gpt-4o にアップグレード**

## 実装設計

### 1. ファイル構成

```
web/src/features/chat/
├── services/
│   ├── handle-chat-request.ts       # 既存（修正）
│   └── web-search-tool.ts           # 新規: Tavily検索ツール定義
└── types/
    └── web-search.ts                # 新規: 検索結果の型定義
```

### 2. 環境変数追加

```env
TAVILY_API_KEY=tvly-xxxxxx
```

### 3. 実装ステップ

#### Step 1: Tavily APIクライアント作成
```typescript
// web/src/features/chat/services/web-search-tool.ts
import { tool } from 'ai';
import { z } from 'zod';

export const webSearchTool = tool({
  description:
    '最新情報や知らない情報を検索する必要がある場合に使用する。' +
    '政治、法案、ニュース、統計など日々更新される情報の取得に有効。',
  parameters: z.object({
    query: z.string()
      .min(1)
      .max(100)
      .describe('検索クエリ（日本語でも英語でも可）')
  }),
  execute: async ({ query }) => {
    const response = await fetch('https://api.tavily.com/search', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        api_key: process.env.TAVILY_API_KEY,
        query,
        search_depth: 'basic', // 'basic' or 'advanced'
        include_answer: true,
        include_raw_content: false,
        max_results: 3,
      }),
    });

    const data = await response.json();
    return {
      answer: data.answer,
      results: data.results.map((r: any) => ({
        title: r.title,
        url: r.url,
        content: r.content,
        score: r.score,
      })),
    };
  },
});
```

#### Step 2: handle-chat-request.ts 修正
```typescript
// 既存のstreamText呼び出し部分を修正
import { webSearchTool } from './web-search-tool';

const result = streamText({
  model: "openai/gpt-4o-mini",
  system: promptResult.content,
  messages: convertToModelMessages(messages),
  tools: {
    webSearch: webSearchTool,
  },
  maxSteps: 5, // ツールを使った推論の最大ステップ数
  experimental_telemetry: {
    isEnabled: true,
    functionId: promptName,
    metadata: buildTelemetryMetadata(context, promptResult, userId),
  },
});
```

#### Step 3: 型定義追加
```typescript
// web/src/features/chat/types/web-search.ts
export type WebSearchResult = {
  answer: string;
  results: Array<{
    title: string;
    url: string;
    content: string;
    score: number;
  }>;
};
```

### 4. プロンプト修正

Langfuseのシステムプロンプトに以下を追記：

```
あなたは日本の法案に関する質問に答えるアシスタントです。

**Web検索の使用:**
- 最新の政治動向、法案の進捗状況、統計データなど、あなたの知識カットオフ以降の情報が必要な場合は`webSearch`ツールを使用してください
- 提供された法案コンテキストに含まれていない情報を補完する必要がある場合も検索を使用できます
- 検索結果は必ず引用元のURLと共に提示してください
```

## テスト計画

1. **基本動作テスト**
   - 検索が不要な質問: 「この法案の目的は？」→ ツール呼び出しなし
   - 検索が必要な質問: 「この法案の最新の審議状況は？」→ ツール呼び出しあり

2. **検索品質テスト**
   - 日本語クエリの精度確認
   - 引用元の正確性確認
   - 無関係な結果への対応

3. **コスト・レイテンシ確認**
   - 1検索あたりのレスポンス時間
   - 無料枠での使用量（1,000クレジット/月で十分か）

## 今後の拡張可能性

1. **他のツール追加**
   - 法案データベース検索
   - 議事録検索
   - 議員情報検索

2. **検索戦略の改善**
   - Advanced Searchへの切り替え（精度向上）
   - 検索結果のキャッシング
   - 検索クエリの自動改善

3. **モデルアップグレード**
   - gpt-4o への切り替えで tool calling 精度向上
   - Claude 3.5 Sonnet など他モデルの検討

## 参考資料

- [Vercel AI SDK - Web Search Agent Cookbook](https://ai-sdk.dev/cookbook/node/web-search-agent)
- [Tavily API Documentation](https://docs.tavily.com/)
- [Vercel AI SDK - Agents](https://vercel.com/docs/agents)
- [AI SDK Tools Registry](https://ai-sdk-agents.vercel.app/)
