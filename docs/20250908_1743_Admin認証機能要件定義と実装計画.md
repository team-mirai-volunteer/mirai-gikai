# Admin 認証機能 - 要件定義と実装計画

## 📋 要件定義

### 1. 基本要件

#### 目的

管理者のみが admin ページにアクセスできる認証システムを構築する

#### 対象ユーザー

- 管理者（政党メンバー）
<!-- - システム管理者 -->

### 2. 機能要件

#### 認証機能

- ✅ Supabase Auth を使用したログイン
- ✅ `app_metadata.roles` による権限管理
- ✅ 管理者権限のないユーザーのアクセス拒否
- ✅ セッション管理とログアウト機能

#### 権限管理

- `admin` - 全機能アクセス可能
- `editor` - コンテンツ編集のみ（将来的に）

#### セキュリティ要件

- ✅ 権限チェックをサーバーサイドで実行
- ✅ 不正アクセス時の適切なリダイレクト
- ✅ セッション有効期限の管理

### 3. 非機能要件

#### パフォーマンス

- 認証チェックのレスポンス時間: 200ms 以内
- セッション確認の頻度: ページロード時

#### ユーザビリティ

- 直感的なログイン画面
- 権限エラー時の分かりやすいメッセージ
- ログイン状態の視覚的フィードバック

## 🏗️ 実装計画

### Phase 1: Supabase 設定とデータベース準備

#### 管理者ユーザー作成

Supabase Studio で手動で作成

<!-- ```sql
-- ユーザーにadmin権限を付与するSQL例
UPDATE auth.users
SET raw_app_meta_data = raw_app_meta_data || '{"roles": ["admin"]}'::jsonb
WHERE email = 'admin@example.com';
``` -->

#### RLS ポリシー設定

特に対応不要

<!-- ```sql
-- 管理者のみアクセス可能なテーブル用RLS
CREATE POLICY "Admin users only" ON public.admin_settings
FOR ALL USING (
  auth.jwt() ->> 'app_metadata'::text::jsonb -> 'roles' ? 'admin'
);
``` -->

### Phase 2: 認証ミドルウェア実装

#### ファイル構成

```
admin/src/
├── middleware.ts                    # 認証チェックミドルウェア
├── lib/
│   ├── supabase/
│   │   └── auth.ts                 # 認証ヘルパー関数
│   └── auth/
│       └── permissions.ts          # 権限チェック関数
```

### Phase 3: ログイン画面実装

#### ページ構成

```
admin/src/app/
├── login/
│   └── page.tsx                    # ログインページ
├── layout.tsx                      # 認証レイアウト
└── (protected)/                    # 保護されたルート
    ├── layout.tsx                  # admin用レイアウト
    └── dashboard/
        └── page.tsx                # ダッシュボード
```

### Phase 4: 権限チェック機能

- Server Actions での権限確認
- RLS (Row Level Security) ポリシー設定
- クライアントサイド権限チェック

## 📝 実装詳細

### 1. Supabase Auth 設定

#### クライアント初期化

packages/supabase にクライアントを作成

#### 権限チェック関数

```typescript
// admin/src/lib/auth/permissions.ts
// @supabase/auth-helpers-nextjsは非推奨です！
// import type { User } from "@supabase/auth-helpers-nextjs";

export async function checkAdminPermission(user: User): Promise<boolean> {
  const roles = user.app_metadata?.roles || [];
  return roles.includes("admin");
}

// export async function checkEditorPermission(user: User): Promise<boolean> {
//   const roles = user.app_metadata?.roles || [];
//   return roles.includes("admin") || roles.includes("editor");
// }
```

### 2. ミドルウェア実装

```typescript
// admin/src/middleware.ts
// @supabase/auth-helpers-nextjsは非推奨です！
// import { createMiddlewareClient } from "@supabase/auth-helpers-nextjs";
import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";

export async function middleware(req: NextRequest) {
  const res = NextResponse.next();
  const supabase = createMiddlewareClient({ req, res });

  const {
    data: { session },
  } = await supabase.auth.getSession();

  // 認証チェック
  if (!session) {
    return NextResponse.redirect(new URL("/login", req.url));
  }

  // admin権限チェック
  const roles = session.user.app_metadata?.roles || [];
  if (!roles.includes("admin")) {
    // ログイン画面に飛ばすでよさそう
    return NextResponse.redirect(new URL("/unauthorized", req.url));
  }

  return res;
}

export const config = {
  matcher: ["/dashboard/:path*", "/api/admin/:path*"],
};
```

### 3. ログイン画面実装

shadcn のコンポーネントを使うこと！

```typescript
// admin/src/app/login/page.tsx
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import { supabase } from "@/lib/supabase/client";

export default function LoginPage() {
  const router = useRouter();
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);

    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });

    if (error) {
      setError("ログインに失敗しました");
      setLoading(false);
      return;
    }

    // admin権限チェック
    const roles = data.user?.app_metadata?.roles || [];
    if (roles.includes("admin")) {
      router.push("/dashboard");
    } else {
      setError("管理者権限がありません");
      await supabase.auth.signOut();
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <div className="max-w-md w-full space-y-8">
        <div>
          <h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">
            管理者ログイン
          </h2>
        </div>
        <form className="mt-8 space-y-6" onSubmit={handleLogin}>
          <div className="rounded-md shadow-sm -space-y-px">
            <div>
              <label htmlFor="email" className="sr-only">
                メールアドレス
              </label>
              <input
                id="email"
                name="email"
                type="email"
                autoComplete="email"
                required
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm"
                placeholder="メールアドレス"
              />
            </div>
            <div>
              <label htmlFor="password" className="sr-only">
                パスワード
              </label>
              <input
                id="password"
                name="password"
                type="password"
                autoComplete="current-password"
                required
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm"
                placeholder="パスワード"
              />
            </div>
          </div>

          {error && (
            <div className="rounded-md bg-red-50 p-4">
              <div className="text-sm text-red-800">{error}</div>
            </div>
          )}

          <div>
            <button
              type="submit"
              disabled={loading}
              className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50"
            >
              {loading ? "ログイン中..." : "ログイン"}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}
```

### 4. 保護されたレイアウト

```typescript
// admin/src/app/(protected)/layout.tsx
import { redirect } from "next/navigation";
import { createServerComponentClient } from "@supabase/auth-helpers-nextjs";
import { cookies } from "next/headers";

export default async function ProtectedLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const supabase = createServerComponentClient({ cookies });
  const {
    data: { session },
  } = await supabase.auth.getSession();

  // 認証処理って、middlewareでやるのでここでは必要ないのでは？
  if (!session) {
    redirect("/login");
  }

  // 認証処理って、middlewareでやるのでここでは必要ないのでは？
  const roles = session.user.app_metadata?.roles || [];
  if (!roles.includes("admin")) {
    redirect("/unauthorized");
  }

  return (
    <div className="min-h-screen bg-gray-100">
      <nav className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between h-16">
            <div className="flex items-center">
              <h1 className="text-xl font-semibold">Admin Dashboard</h1>
            </div>
            <div className="flex items-center">
              <span className="text-sm text-gray-700 mr-4">
                {session.user.email}
              </span>
              <button
                onClick={async () => {
                  await supabase.auth.signOut();
                  redirect("/login");
                }}
                className="text-sm text-red-600 hover:text-red-500"
              >
                ログアウト
              </button>
            </div>
          </div>
        </div>
      </nav>
      <main className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">{children}</main>
    </div>
  );
}
```

## 📊 タスク優先順位

### 高優先度 (Week 1)

1. ✅ Supabase Auth 基本設定
2. ✅ 管理者ユーザー作成と roles 設定
3. ✅ ミドルウェア実装
4. ✅ ログイン画面作成

### 中優先度 (Week 2)

1. ⏳ ダッシュボード画面
2. ⏳ セッション管理
3. ⏳ エラーハンドリング改善

### 低優先度 (Week 3)

1. ⏳ 複数権限レベル対応
2. ⏳ ログイン履歴
3. ⏳ セキュリティ監査機能

## 🧪 テスト計画

### 単体テスト

- 権限チェック関数
- 認証ヘルパー関数

### 結合テスト

- ログインフロー
- 権限チェックフロー
- セッション管理

### E2E テスト

- 管理者ログイン成功ケース
- 権限なしユーザーアクセス拒否
- セッション切れ時の動作

## 🔒 セキュリティ考慮事項

### 認証関連

- パスワードの最小長要件（8 文字以上）
- ブルートフォース攻撃対策（レート制限）
- セッション有効期限（24 時間）

### データ保護

- HTTPS による通信の暗号化
- CSRF トークンによる保護
- XSS 対策（入力値のサニタイゼーション）

### 監査

- ログイン試行の記録
- 管理者操作のログ記録
- 定期的なセキュリティレビュー

## 📚 参考資料

- [Supabase Auth Documentation](https://supabase.com/docs/guides/auth)
- [Next.js Authentication Best Practices](https://nextjs.org/docs/authentication)
- [Row Level Security (RLS) Guide](https://supabase.com/docs/guides/auth/row-level-security)
