# Admin議案編集機能 実装計画書

## 1. 実装概要

管理者向け議案編集機能を2段階で実装する：
1. 議案基本情報編集機能（bills）
2. 議案コンテンツ編集機能（bill_contents）

## 2. 実装スケジュール

### Phase 1: 議案基本情報編集機能（2日）

#### Day 1: 基盤実装
- [ ] 編集ページのルーティング設定
- [ ] Server Actions作成（update-bill.ts）
- [ ] 型定義とバリデーションスキーマ作成

#### Day 2: UI実装
- [ ] 議案編集フォームコンポーネント作成
- [ ] 一覧画面に編集ボタン追加
- [ ] エラーハンドリングとフィードバック実装

### Phase 2: 議案コンテンツ編集機能（3日）

#### Day 3: 基盤実装
- [ ] コンテンツ編集ページのルーティング設定
- [ ] Server Actions作成（update-bill-contents.ts）
- [ ] データ取得関数作成（get-bill-contents.ts）

#### Day 4: UI実装
- [ ] タブ切り替えコンポーネント作成
- [ ] 難易度別編集フォーム作成
- [ ] Markdown入力エリア実装

#### Day 5: 統合とテスト
- [ ] 一覧画面にコンテンツ編集リンク追加
- [ ] バリデーション実装
- [ ] 動作確認とバグ修正

## 3. 技術実装詳細

### 3.1 ディレクトリ構造

```
admin/src/
├── app/(protected)/bills/
│   ├── [id]/
│   │   ├── edit/
│   │   │   └── page.tsx              # 議案基本情報編集ページ
│   │   └── contents/
│   │       └── edit/
│   │           └── page.tsx          # 議案コンテンツ編集ページ
│   └── page.tsx                      # 議案一覧（既存）
│
└── features/bills/
    ├── components/
    │   ├── bill-list/
    │   │   └── bill-list.tsx         # 編集ボタン追加
    │   ├── bill-edit-form.tsx        # 基本情報編集フォーム
    │   └── bill-contents-edit-form.tsx # コンテンツ編集フォーム
    ├── actions/
    │   ├── update-bill.ts             # 基本情報更新
    │   └── update-bill-contents.ts   # コンテンツ更新
    ├── api/
    │   ├── get-bills.ts              # 既存
    │   ├── get-bill-by-id.ts        # 議案詳細取得
    │   └── get-bill-contents.ts     # コンテンツ取得
    └── types/
        └── index.ts                   # 型定義（更新）
```

### 3.2 主要コンポーネント仕様

#### BillEditForm コンポーネント
```typescript
// 議案基本情報編集フォーム
- useForm (react-hook-form) でフォーム管理
- zodResolver でバリデーション
- Server Action呼び出しで更新
- 成功/失敗フィードバック表示
```

#### BillContentsEditForm コンポーネント
```typescript
// 議案コンテンツ編集フォーム
- タブ切り替えで3つの難易度を管理
- 各難易度ごとにフォームフィールド
- Markdownテキストエリア
- 一括保存（全難易度同時）
```

### 3.3 Server Actions

#### update-bill.ts
```typescript
"use server"

export async function updateBill(
  id: string,
  data: BillUpdateInput
) {
  // 認証チェック
  // バリデーション
  // Supabase更新
  // リダイレクト or エラー返却
}
```

#### update-bill-contents.ts
```typescript
"use server"

export async function updateBillContents(
  billId: string,
  contents: BillContentsUpdateInput[]
) {
  // 認証チェック
  // バリデーション
  // 3つの難易度を一括更新
  // リダイレクト or エラー返却
}
```

### 3.4 バリデーションスキーマ

```typescript
// Zod schemas
const BillUpdateSchema = z.object({
  name: z.string().min(1).max(200),
  status: z.enum(['introduced', 'in_originating_house', ...]),
  originating_house: z.enum(['HR', 'HC']),
  status_note: z.string().max(500).nullable(),
  published_at: z.string().datetime(),
});

const BillContentSchema = z.object({
  difficulty_level: z.enum(['easy', 'normal', 'hard']),
  title: z.string().min(1).max(200),
  summary: z.string().min(1).max(1000),
  content: z.string().min(1),
});
```

## 4. UI/UXデザイン

### 4.1 議案編集画面
- カード形式のフォーム
- 各フィールドにラベルとヘルプテキスト
- セレクトボックスでenum選択
- 日時選択にはdatetime-local input使用

### 4.2 コンテンツ編集画面
- タブナビゲーション（やさしい/ふつう/難しい）
- 各タブに同じフォーム構造
- テキストエリアは十分な高さ確保（10行以上）
- Markdown記法のヒント表示

### 4.3 フィードバック
- 保存中: ローディングスピナー
- 成功: トースト通知 or 成功メッセージ
- エラー: フォーム上にエラー表示

## 5. 実装上の考慮事項

### 5.1 パフォーマンス
- Server Componentsで初期データ取得
- Server Actionsで更新処理
- クライアントサイドは最小限

### 5.2 エラーハンドリング
- try-catchでServer Actionエラー捕捉
- ユーザーフレンドリーなエラーメッセージ
- ネットワークエラー対応

### 5.3 アクセシビリティ
- フォームラベルの適切な設定
- エラーメッセージのaria属性
- キーボード操作対応

## 6. テスト項目

### 機能テスト
- [ ] 議案基本情報の更新が正しく保存される
- [ ] コンテンツの3つの難易度が正しく保存される
- [ ] バリデーションエラーが表示される
- [ ] 権限チェックが機能する

### UIテスト
- [ ] フォーム入力が正しく動作する
- [ ] タブ切り替えが正しく動作する
- [ ] エラー表示が適切
- [ ] 成功フィードバックが表示される

## 7. リスクと対策

| リスク | 対策 |
|--------|------|
| 同時編集による上書き | 現時点では排他制御なし。将来的に楽観的ロック実装を検討 |
| 大量のMarkdownテキスト | テキストエリアのパフォーマンス監視、必要に応じて最適化 |
| 権限不正アクセス | Server Action内で必ず認証チェック実施 |

## 8. 将来の拡張性

- Markdownプレビュー機能
- 自動保存（下書き）機能
- 編集履歴・バージョン管理
- リッチテキストエディタ導入
- 一括編集機能