# みらい議会 MVP DBスキーマ設計

## 概要
みらい議会MVPにおけるデータベーススキーマの設計書です。
Supabase（PostgreSQL）を使用することを前提としています。

## ENUM型定義

```sql
-- 発議院
CREATE TYPE house_enum AS ENUM ('HR', 'HC');

-- 議案ステータス
CREATE TYPE bill_status_enum AS ENUM (
    'introduced',
    'in_originating_house',
    'in_receiving_house',
    'enacted',
    'rejected'
);

-- スタンスタイプ
CREATE TYPE stance_type_enum AS ENUM ('for', 'against', 'neutral');

-- チャットロール
CREATE TYPE chat_role_enum AS ENUM ('user', 'system', 'assistant');
```

## テーブル定義

### 1. bills（議案）
議案の基本情報を管理するテーブル

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | UUID | PRIMARY KEY, DEFAULT uuid_generate_v4() | 議案ID |
| name | TEXT | NOT NULL | 議案名 |
| headline | TEXT | | 見出し・要約 |
| description | TEXT | | 議案の詳細説明 |
| originating_house | house_enum | NOT NULL | 発議院（HR:衆議院, HC:参議院） |
| status | bill_status_enum | NOT NULL | 議案のステータス |
| status_note | TEXT | | ステータスに関する補足情報 |
| published_at | TIMESTAMP WITH TIME ZONE | NOT NULL | サービスでの議案公開日時 |
| body_markdown | TEXT | | 議案本文（Markdown形式） |
| created_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT NOW() | レコード作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT NOW() | レコード更新日時 |

**インデックス:**
- `idx_bills_status` ON (status)
- `idx_bills_published_at` ON (published_at DESC)
- `idx_bills_originating_house` ON (originating_house)

### 2. mirai_stances（みらいスタンス）
チームみらい（安野議員）の公式スタンスを記録するテーブル

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | UUID | PRIMARY KEY, DEFAULT uuid_generate_v4() | スタンスID |
| bill_id | UUID | NOT NULL, UNIQUE, REFERENCES bills(id) ON DELETE CASCADE | 議案ID |
| type | stance_type_enum | NOT NULL | スタンス（賛成/反対/中立） |
| comment | TEXT | | スタンスに関するコメント・理由 |
| created_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT NOW() | レコード作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT NOW() | レコード更新日時 |

**インデックス:**
- `idx_mirai_stances_bill_id` ON (bill_id)
- `idx_mirai_stances_type` ON (type)

### 3. chats（チャット）
AIとの対話履歴を管理するテーブル

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | UUID | PRIMARY KEY, DEFAULT uuid_generate_v4() | チャットID |
| bill_id | UUID | NOT NULL, REFERENCES bills(id) ON DELETE CASCADE | 議案ID |
| user_id | UUID | | ユーザーID（Supabase匿名認証） |
| role | chat_role_enum | NOT NULL | メッセージの送信者役割 |
| message | TEXT | NOT NULL | メッセージ内容 |
| created_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT NOW() | レコード作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT NOW() | レコード更新日時 |

**インデックス:**
- `idx_chats_bill_id` ON (bill_id)
- `idx_chats_user_id` ON (user_id)
- `idx_chats_created_at` ON (created_at DESC)
- `idx_chats_bill_user` ON (bill_id, user_id)

## スキーマの特徴

### 1. UUID の採用
- 全テーブルの主キーにUUIDを使用
- 分散システムでの拡張性を考慮
- Supabaseのデフォルト設定に準拠

### 2. タイムスタンプの統一
- 全テーブルに `created_at` と `updated_at` を実装
- `TIMESTAMP WITH TIME ZONE` 型でタイムゾーンを考慮
- トリガーで `updated_at` の自動更新を実装予定

### 3. カスケード削除
- 議案が削除された場合、関連する `mirai_stances` と `chats` も自動削除
- データの整合性を維持

### 4. 型安全性
- PostgreSQLのENUM型を使用して型安全性を確保
- アプリケーション層でも型定義として利用可能

## Row Level Security (RLS) ポリシー

全テーブルでRLSを有効化し、デフォルトで全アクセスを禁止します。
サーバーサイド（Service Role Key使用）からのみアクセス可能とします。

### 設定方針
- 全テーブル: RLS有効化
- デフォルトポリシー: 全操作を禁止
- アクセス方法: Supabase Service Role Keyを使用したサーバーサイドアクセスのみ

## 更新履歴
- 2025/09/04: 初版作成（MVP版）