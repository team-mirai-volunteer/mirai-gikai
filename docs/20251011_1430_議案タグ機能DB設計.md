# 議案タグ機能 DB設計

## 概要

議案（bills）に対してタグを付与できる機能のデータベース設計。
bill と tag は多対多（n:m）の関係となるため、中間テーブル `bills_tags` を使用する。

## テーブル設計

### 1. tags テーブル

タグのマスターテーブル。

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY, DEFAULT uuid_generate_v4() | タグID |
| label | TEXT | NOT NULL | タグのラベル（表示名） |
| created_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT NOW() | 更新日時 |

### 2. bills_tags テーブル

議案とタグの紐付けを管理する中間テーブル。

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| bill_id | UUID | NOT NULL, REFERENCES bills(id) ON DELETE CASCADE | 議案ID |
| tag_id | UUID | NOT NULL, REFERENCES tags(id) ON DELETE CASCADE | タグID |
| created_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT NOW() | 作成日時 |

**複合主キー**: (bill_id, tag_id) - 同じ議案に同じタグを複数回付与できないようにする

## データ制約

### 一意性制約
- `bills_tags` テーブルの (bill_id, tag_id) を複合主キーとすることで、同じ議案に同じタグを複数付与できないようにする

### 削除時の動作
- **タグ削除時**: `ON DELETE CASCADE` により、紐付けられている bills_tags レコードも自動削除される
- **議案削除時**: `ON DELETE CASCADE` により、紐付けられている bills_tags レコードも自動削除される

## RLSポリシー

既存の `bills` テーブルと同様に、RLSは有効化するがポリシーは設定しない（デフォルト拒否）。
アクセスはSupabase Service Role経由で行う想定。

- `tags`: RLS ON, ポリシーなし
- `bills_tags`: RLS ON, ポリシーなし

## Supabase実装手順

### 1. マイグレーションファイルの作成

```bash
# 現在のタイムスタンプでマイグレーションファイルを作成
cd supabase
supabase migration new add_tags_and_bills_tags_tables
```

実行すると `supabase/migrations/YYYYMMDDHHMMSS_add_tags_and_bills_tags_tables.sql` が生成される。

### 2. マイグレーションSQLの記述

生成されたファイルに以下のSQLを記述：

```sql
-- Create tags table
CREATE TABLE tags (
    id UUID PRIMARY KEY DEFAULT extensions.uuid_generate_v4(),
    label TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- Create bills_tags junction table
CREATE TABLE bills_tags (
    bill_id UUID NOT NULL REFERENCES bills(id) ON DELETE CASCADE,
    tag_id UUID NOT NULL REFERENCES tags(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    PRIMARY KEY (bill_id, tag_id)
);

-- Create trigger for tags updated_at
CREATE TRIGGER update_tags_updated_at BEFORE UPDATE ON tags
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Enable Row Level Security
ALTER TABLE tags ENABLE ROW LEVEL SECURITY;
ALTER TABLE bills_tags ENABLE ROW LEVEL SECURITY;

-- No policies are created, so all access is denied by default
-- Access will only be possible using Supabase Service Role Key from server-side

-- Add comments for documentation
COMMENT ON TABLE tags IS 'タグのマスターテーブル';
COMMENT ON COLUMN tags.label IS 'タグのラベル（表示名）';

COMMENT ON TABLE bills_tags IS '議案とタグの紐付けを管理する中間テーブル';
COMMENT ON COLUMN bills_tags.bill_id IS '議案ID';
COMMENT ON COLUMN bills_tags.tag_id IS 'タグID';
```

### 3. ローカル環境での適用

```bash
# Supabaseローカル環境が起動していることを確認
supabase status

# 起動していない場合は起動
supabase start

# マイグレーションを適用
supabase db reset
```

### 4. 動作確認

```bash
# Supabase Studio を開く（ブラウザで確認）
# http://127.0.0.1:54323 でアクセス

# または psql でテーブルを確認
supabase db diff
```

以下を確認：
- `tags` テーブルが作成されている
- `bills_tags` テーブルが作成されている
- 複合主キー (bill_id, tag_id) が設定されている
- 外部キー制約が設定されている
- RLSが有効になっている
- updated_at トリガーが tags テーブルに設定されている

### 5. 本番環境への適用

```bash
# 本番環境にリンク（初回のみ）
supabase link --project-ref <your-project-ref>

# マイグレーションをプッシュ
supabase db push
```

## TypeScript型定義の更新

マイグレーション適用後、型定義を再生成する：

```bash
# ローカル環境から型定義を生成
supabase gen types typescript --local > packages/supabase/src/types/database.types.ts
```

または

```bash
# 本番環境から型定義を生成
supabase gen types typescript --linked > packages/supabase/src/types/database.types.ts
```

## 使用例（参考）

### タグの作成

```typescript
const { data, error } = await supabase
  .from('tags')
  .insert({ label: '重要' })
  .select()
  .single();
```

### 議案へのタグ付与

```typescript
const { error } = await supabase
  .from('bills_tags')
  .insert({
    bill_id: 'bill-uuid-here',
    tag_id: 'tag-uuid-here'
  });
```

### 議案に紐付くタグの取得

```typescript
const { data, error } = await supabase
  .from('bills_tags')
  .select(`
    tag_id,
    tags (
      id,
      label
    )
  `)
  .eq('bill_id', 'bill-uuid-here');
```

### タグに紐付く議案の取得

```typescript
const { data, error } = await supabase
  .from('bills_tags')
  .select(`
    bill_id,
    bills (
      id,
      name,
      headline
    )
  `)
  .eq('tag_id', 'tag-uuid-here');
```

### タグの削除（紐付けも自動削除）

```typescript
// ON DELETE CASCADE により bills_tags の関連レコードも自動削除される
const { error } = await supabase
  .from('tags')
  .delete()
  .eq('id', 'tag-uuid-here');
```

## 今後の拡張案（参考）

現在は最小限の設計だが、将来的に以下のような拡張が考えられる：

- タグに色属性を追加（color カラム）
- タグにカテゴリーを追加（category カラム）
- タグに並び順を追加（sort_order カラム）
- タグのラベルに一意制約を追加（同名タグの重複防止）
- bills_tags に並び順を追加（議案に対するタグの表示順）
- パフォーマンス改善のためのインデックス追加

これらは必要に応じて別マイグレーションで追加することが可能。
