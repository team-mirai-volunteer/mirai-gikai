# インタビュー実施からレポート生成までのフロー

## 概要

法案に対するユーザーの意見を収集するAIインタビューシステム。
インタビューは3つのフェーズで構成され、最終的に構造化されたレポートがDBに保存される。

## フェーズ

```
[chat] → [summary] → [summary_complete]
```

| フェーズ | 説明 |
|---------|------|
| chat | インタビュー進行中。AIが質問し、ユーザーが回答 |
| summary | AIがレポート案を生成し、ユーザーに確認を求める |
| summary_complete | ユーザーがレポートに同意し、DBに保存完了 |

## シーケンス図

```
┌──────────┐     ┌──────────┐     ┌──────────────┐     ┌────────────┐
│  User    │     │  Client  │     │   API        │     │    DB      │
└────┬─────┘     └────┬─────┘     └──────┬───────┘     └─────┬──────┘
     │                │                   │                   │
     │ インタビュー開始 │                   │                   │
     │───────────────>│                   │                   │
     │                │ GET /bills/[id]/interview/chat        │
     │                │──────────────────>│                   │
     │                │                   │ セッション作成/取得 │
     │                │                   │──────────────────>│
     │                │                   │<──────────────────│
     │                │<──────────────────│                   │
     │                │                   │                   │
     │ ========== chatフェーズ ===========│                   │
     │                │                   │                   │
     │ メッセージ送信  │                   │                   │
     │───────────────>│                   │                   │
     │                │ POST /api/interview/facilitate        │
     │                │──────────────────>│ (進行状況判定)     │
     │                │<──────────────────│ {status: "continue" or "summary"}
     │                │                   │                   │
     │                │ POST /api/interview/chat              │
     │                │──────────────────>│                   │
     │                │                   │ メッセージ保存     │
     │                │                   │──────────────────>│
     │                │   (streaming)     │ LLM応答生成       │
     │                │<─ ─ ─ ─ ─ ─ ─ ─ ─│                   │
     │<───────────────│                   │                   │
     │                │                   │                   │
     │ ========== summaryフェーズ ========│                   │
     │                │                   │                   │
     │                │ POST /api/interview/chat              │
     │                │──────────────────>│ (currentStage: "summary")
     │                │                   │                   │
     │                │   (streaming)     │ LLM: text + report生成
     │                │<─ ─ ─ ─ ─ ─ ─ ─ ─│ {text, report}    │
     │                │                   │ メッセージ保存(JSON)│
     │                │                   │──────────────────>│
     │<───────────────│                   │                   │
     │                │                   │                   │
     │ 「レポート内容に同意する」クリック   │                   │
     │───────────────>│                   │                   │
     │                │ POST /api/interview/complete          │
     │                │──────────────────>│                   │
     │                │                   │ メッセージからreport抽出
     │                │                   │ interview_reportに保存│
     │                │                   │──────────────────>│
     │                │                   │ session.completed_at更新
     │                │                   │──────────────────>│
     │                │<──────────────────│ {report}          │
     │<───────────────│                   │                   │
     │                │                   │                   │
     │ レポート画面へ遷移                  │                   │
     │───────────────>│ /report/[reportId]│                   │
```

## 主要ファイル

### ページ・コンポーネント

| ファイル | 説明 |
|---------|------|
| `web/src/app/bills/[id]/interview/chat/page.tsx` | インタビューチャット画面（Server Component） |
| `web/src/features/interview-session/client/components/interview-chat-client.tsx` | チャットUI（Client Component） |
| `web/src/features/interview-session/client/components/interview-message.tsx` | メッセージ表示 |
| `web/src/features/interview-session/client/components/interview-report.tsx` | レポート表示 |

### フック

| ファイル | 説明 |
|---------|------|
| `use-interview-chat.ts` | チャット全体の状態管理 |
| `use-interview-completion.ts` | 完了処理（レポート保存）の管理 |
| `use-parsed-messages.ts` | 初期メッセージのパース |

### API

| エンドポイント | ファイル | 説明 |
|---------------|---------|------|
| `POST /api/interview/chat` | `route.ts` | チャットメッセージのストリーミング |
| `POST /api/interview/facilitate` | `route.ts` | フェーズ遷移の判定 |
| `POST /api/interview/complete` | `route.ts` | レポート保存・セッション完了 |

### サービス

| ファイル | 説明 |
|---------|------|
| `handle-interview-chat-request.ts` | チャットリクエスト処理、LLM呼び出し |
| `facilitate-interview.ts` | 進行状況判定（continue/summary/summary_complete） |
| `complete-interview-session.ts` | summaryフェーズのメッセージからレポート抽出・保存 |
| `build-interview-system-prompt.ts` | システムプロンプト構築 |

## プロンプト

### chatフェーズ: `buildInterviewSystemPrompt`

- 法案情報、テーマ、知識ソース、事前定義質問を含む
- インタビューの進め方、クイックリプライの扱いを指示

### summaryフェーズ: `buildSummarySystemPrompt`

- 法案情報、テーマを含む
- レポート生成の指示（summary, stance, role, opinions, scores）

## スキーマ

### チャットレスポンス

```typescript
// chatフェーズ
{
  text: string;
  quick_replies: string[] | null;
  question_id: string | null;
}

// summaryフェーズ
{
  text: string;  // 固定の導入文（例: 「インタビュー内容を以下のようにまとめました。」）
  report: InterviewReportData;
}
```

### レポートデータ (`InterviewReportData`)

```typescript
{
  summary: string | null;       // 主張の要約（20文字以内）
  stance: "for" | "against" | "neutral" | null;  // 賛否
  role: string | null;          // 立場・属性
  role_description: string | null;  // 立場の詳細
  opinions: Array<{             // 具体的な主張（最大3件）
    title: string;              // タイトル（40文字以内）
    content: string;            // 説明（120文字以内）
  }>;
  scores: {                     // スコアリング（内部評価用）
    total: number;              // 総合スコア（0-100）
    clarity: number;            // 主張の明確さ
    specificity: number;        // 具体性
    impact: number;             // 影響度
    constructiveness: number;   // 建設性
    reasoning: string;          // 根拠（100文字以内）
  };
}
```

## DB構造

### `interview_sessions`

| カラム | 型 | 説明 |
|-------|-----|------|
| id | UUID | セッションID |
| interview_config_id | UUID | インタビュー設定への参照 |
| user_id | UUID | ユーザーID |
| started_at | TIMESTAMP | 開始日時 |
| completed_at | TIMESTAMP | 完了日時（null = 進行中） |
| archived_at | TIMESTAMP | アーカイブ日時（やり直し時） |

### `interview_messages`

| カラム | 型 | 説明 |
|-------|-----|------|
| id | UUID | メッセージID |
| interview_session_id | UUID | セッションへの参照 |
| role | TEXT | "user" or "assistant" |
| content | TEXT | メッセージ内容（summaryフェーズはJSON） |
| created_at | TIMESTAMP | 作成日時 |

### `interview_report`

| カラム | 型 | 説明 |
|-------|-----|------|
| id | UUID | レポートID |
| interview_session_id | UUID | セッションへの参照（UNIQUE） |
| summary | TEXT | 主張の要約 |
| stance | ENUM | 賛否（for/against/neutral等） |
| role | TEXT | 立場・属性 |
| role_description | TEXT | 立場の詳細 |
| opinions | JSONB | 意見リスト |
| scores | JSONB | スコアリング |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

## 設計のポイント

### 1. LLM呼び出しの一貫性

summaryフェーズで生成したレポートをそのままDBに保存することで、ユーザーが確認した内容と保存される内容の一貫性を保証。

```
❌ 以前の設計: summary生成 → ユーザー確認 → 再度LLM呼び出しでレポート生成
✅ 現在の設計: summary生成(構造化出力) → ユーザー確認 → そのまま保存
```

### 2. クライアント表示用の型分離

`scores` はユーザーには表示せず内部評価用のため、表示用に `InterviewReportViewData` を定義。

```typescript
type InterviewReportViewData = Omit<InterviewReportData, "scores">;
```

### 3. 固定の導入文

summaryフェーズの `text` フィールドはLLMが生成するが、表示時は固定文（「インタビュー内容を以下のようにまとめました。」）を使用して一貫性を確保。
