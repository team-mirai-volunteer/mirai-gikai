# AIチャット機能 要件定義書

## 1. 概要

議案詳細ページにAIチャット機能を実装し、ユーザーが議案に関する質問をAIに問い合わせできるようにする。

## 2. 機能要件

### 2.1 基本機能
- **議案コンテキスト認識**: AIは現在表示している議案の内容（名称、説明、詳細内容、みらいのスタンス等）を自動的に把握して回答
- **質問制限**: 議案に関する質問のみ対応（他の質問は丁寧に断る）
- **ストリーミング応答**: AIの回答をリアルタイムでストリーミング表示
- **マークダウンレンダリング**: AIの回答をマークダウンとして適切にレンダリング

### 2.2 UI/UX要件
- **フローティングウィンドウ**: 右下に固定されたチャットボタンから展開するフローティングウィンドウ形式
- **初期メッセージ**: AIからの挨拶とガイダンスメッセージを表示
- **レスポンシブデザイン**: スマホファーストで設計、デスクトップでも最適な表示
- **アクセシビリティ**: 誰でも利用可能（認証不要）

### 2.3 非機能要件
- **永続化**: 会話履歴の保存は不要（ページリロードで履歴リセット）
- **パフォーマンス**: ストリーミング応答により体感速度を向上
- **エラーハンドリング**: API エラー時の適切なメッセージ表示

## 3. 技術仕様

### 3.1 使用技術スタック
- **フレームワーク**: Next.js 15 (App Router)
- **AI SDK**: Vercel AI SDK
- **LLMプロバイダ**: OpenAI (GPT-4o-mini推奨)
- **API Gateway**: Vercel AI Gateway（オプション）
- **UIコンポーネント**: Vercel AI SDK UI (ai/react-ui)
- **マークダウン**: Streamdown（ストリーミング対応マークダウンレンダラー）
- **スタイリング**: Tailwind CSS

### 3.2 データフロー
1. ユーザーが議案詳細ページにアクセス
2. チャットボタンをクリックしてチャットウィンドウを開く
3. ユーザーが質問を入力
4. 議案データとユーザーの質問を含むプロンプトをAPIに送信
5. OpenAI APIからストリーミングレスポンスを受信
6. Streamdownでマークダウンをレンダリング
7. チャットウィンドウに表示

## 4. UI仕様

### 4.1 チャットボタン
- **位置**: 画面右下に固定配置
- **デザイン**: 円形のフローティングアクションボタン
- **アイコン**: メッセージアイコン（lucide-react）
- **インタラクション**: クリックでチャットウィンドウの開閉

### 4.2 チャットウィンドウ
- **サイズ**: 
  - モバイル: 全画面（高さ70vh、幅100vw）
  - デスクトップ: 幅400px、高さ600px
- **位置**: 
  - モバイル: 下から上にスライドアップ
  - デスクトップ: 右下に固定
- **構成要素**:
  - ヘッダー: タイトル「議案について質問する」と閉じるボタン
  - メッセージエリア: スクロール可能な会話履歴
  - 入力エリア: テキスト入力フィールドと送信ボタン

### 4.3 メッセージ表示
- **AIメッセージ**: 左寄せ、グレー背景
- **ユーザーメッセージ**: 右寄せ、プライマリーカラー背景
- **タイピングインジケーター**: AIが応答生成中に表示
- **マークダウンサポート**: リスト、強調、コードブロック等

## 5. API仕様

### 5.1 エンドポイント
```
POST /api/chat
```

### 5.2 リクエスト
```typescript
{
  messages: Message[]
  billContext: {
    id: string
    name: string
    description?: string
    content?: string
    miraiStance?: {
      position: string
      reason: string
    }
  }
}
```

### 5.3 レスポンス
- ストリーミングレスポンス（Server-Sent Events）
- マークダウン形式のテキスト

## 6. プロンプト設計

### 6.1 システムプロンプト
```
あなたは日本の議案について説明する専門的なアシスタントです。
以下の議案に関する質問にのみ回答してください。

議案情報：
- 名称: [議案名]
- 説明: [議案説明]
- 詳細: [議案内容]
- みらいのスタンス: [スタンス情報]

ルール：
1. この議案に関する質問にのみ回答する
2. 分かりやすく簡潔に説明する
3. 専門用語は必要に応じて解説する
4. 議案と無関係の質問には「申し訳ございません。この議案に関する質問にお答えします」と返答する
```

### 6.2 初期メッセージ
```
こんにちは！この議案について、ご質問はありませんか？

例えば、以下のような質問にお答えできます：
- この議案の目的は何ですか？
- どのような影響がありますか？
- みらいはなぜこのスタンスを取っているのですか？

お気軽にご質問ください。
```

## 7. 制約事項

- レート制限、コスト管理、データ保護は初期実装では考慮しない
- 会話履歴の永続化は実装しない
- ベクトルDBは使用せず、議案内容を直接プロンプトに含める
- 認証機能は実装しない（誰でも利用可能）

## 8. 将来の拡張性

- 会話履歴の保存機能
- ユーザーごとの利用履歴管理
- RAG実装によるより詳細な情報提供
- 複数の議案を横断した質問への対応
- 投票シミュレーション機能