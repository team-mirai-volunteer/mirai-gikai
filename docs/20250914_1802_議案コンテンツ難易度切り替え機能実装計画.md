# 議案コンテンツ難易度切り替え機能 実装計画書

## 1. 実装概要

### 1.1 実装範囲

議案詳細ページにおける 3 段階（やさしい・ふつう・難しい）の難易度切り替え機能を実装する。

### 1.2 技術スタック

- **フロントエンド**: Next.js (App Router), React, TypeScript
- **状態管理**: React Context API + Cookies
- **データベース**: Supabase (PostgreSQL)
- **スタイリング**: Tailwind CSS
<!-- - **アニメーション**: Framer Motion -->

## 2. 実装フェーズ

### フェーズ 1: データベース設計・実装（2 日）

### フェーズ 2: バックエンド API 実装（2 日）

### フェーズ 3: フロントエンド実装（3 日）

### フェーズ 4: テスト・調整（1 日）

**合計工数**: 8 日

## 3. 詳細実装計画

### 3.1 フェーズ 1: データベース設計・実装

#### 3.1.1 テーブル作成

```sql
-- 議案コンテンツテーブル
CREATE TYPE difficulty_level_enum AS ENUM ('easy', 'normal', 'hard');

CREATE TABLE bill_contents (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  bill_id UUID NOT NULL REFERENCES bills(id) ON DELETE CASCADE,
  difficulty_level difficulty_level_enum NOT NULL,
  title TEXT NOT NULL,
  summary TEXT NOT NULL,
  content TEXT NOT NULL, -- Markdown形式
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  UNIQUE(bill_id, difficulty_level)
);

-- インデックス作成
CREATE INDEX idx_bill_contents_bill_id ON bill_contents(bill_id);
CREATE INDEX idx_bill_contents_difficulty ON bill_contents(difficulty_level);

-- updated_atトリガー
CREATE TRIGGER update_bill_contents_updated_at BEFORE UPDATE ON bill_contents
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Row Level Security
ALTER TABLE bill_contents ENABLE ROW LEVEL SECURITY;

-- テーブルコメント
COMMENT ON TABLE bill_contents IS '議案の難易度別コンテンツを管理するテーブル';
COMMENT ON COLUMN bill_contents.difficulty_level IS '難易度レベル（easy:やさしい, normal:ふつう, hard:難しい）';
COMMENT ON COLUMN bill_contents.content IS 'Markdown形式の議案内容';
```

#### 3.1.2 既存データの削除と初期データ投入

- 既存の議案データを全削除
- packages/seed を編集
- サンプルデータを 3 段階分作成して投入

### 3.2 フェーズ 2: バックエンド実装

#### 3.2.1 Supabase Types 更新

```bash
pnpm supabase:types:gen
```

#### 3.2.2 データアクセス層の実装（RSC 用）

ファイル構成は既存のものを参考にする！

**`features/bills/api/bills-api.ts`**

```typescript
import { createClient } from "@/lib/supabase/server";

export const billsApi = {
  // 議案と指定難易度のコンテンツを取得（RSC用）
  getBillWithContent: async (billId: string, difficulty: DifficultyLevel) => {
    const supabase = createClient();

    const { data: bill } = await supabase
      .from("bills")
      .select(
        `
        *,
        bill_contents!inner(
          *
        )
      `
      )
      .eq("id", billId)
      .eq("bill_contents.difficulty_level", difficulty)
      .single();

    return bill;
  },

  // 特定難易度のコンテンツのみ取得
  getBillContent: async (billId: string, difficulty: DifficultyLevel) => {
    const supabase = createClient();

    const { data } = await supabase
      .from("bill_contents")
      .select("*")
      .eq("bill_id", billId)
      .eq("difficulty_level", difficulty)
      .single();

    return data;
  },

  // 全難易度のコンテンツを取得（クライアントサイドキャッシュ用）
  getAllDifficultyContents: async (billId: string) => {
    const supabase = createClient();

    const { data } = await supabase
      .from("bill_contents")
      .select("*")
      .eq("bill_id", billId);

    // 難易度をキーとしたオブジェクトに変換
    return data?.reduce((acc, content) => {
      acc[content.difficulty_level] = content;
      return acc;
    }, {} as Record<DifficultyLevel, BillContent>);
  },
};
```

### 3.3 フェーズ 3: フロントエンド実装

#### 3.3.1 Cookieベースの難易度管理（Context不使用）

**サーバーコンポーネントを最大限活用するため、Contextを使わずにCookieとServer Actionsで実装します。**

**`features/bills/actions/difficulty-actions.ts`**

```typescript
'use server';

import { cookies } from 'next/headers';
import { revalidatePath } from 'next/cache';

const COOKIE_NAME = 'content_difficulty_level';
const COOKIE_MAX_AGE = 60 * 60 * 24 * 365; // 1年

export async function setDifficultyLevel(level: DifficultyLevel, currentPath: string) {
  cookies().set(COOKIE_NAME, level, {
    maxAge: COOKIE_MAX_AGE,
    path: '/',
    sameSite: 'lax',
    secure: process.env.NODE_ENV === 'production',
  });
  
  // ページを再検証して新しい難易度で再レンダリング
  revalidatePath(currentPath);
}

export async function getDifficultyLevel(): Promise<DifficultyLevel> {
  const cookieStore = cookies();
  const difficulty = cookieStore.get(COOKIE_NAME);
  return (difficulty?.value as DifficultyLevel) || 'normal';
}
```

#### 3.3.2 難易度切り替え UI コンポーネント

**`features/bills/components/difficulty-selector.tsx`**

```typescript
'use client';

import { usePathname } from 'next/navigation';
import { setDifficultyLevel } from '../actions/difficulty-actions';

interface DifficultySelectorProps {
  currentDifficulty: DifficultyLevel;
}

export const DifficultySelector: React.FC<DifficultySelectorProps> = ({ 
  currentDifficulty 
}) => {
  const pathname = usePathname();

  const levels = [
    { value: 'easy' as const, label: 'やさしい', emoji: '👶' },
    { value: 'normal' as const, label: 'ふつう', emoji: '👨' },
    { value: 'hard' as const, label: '難しい', emoji: '🎓' },
  ];

  const handleDifficultyChange = async (level: DifficultyLevel) => {
    await setDifficultyLevel(level, pathname);
  };

  return (
    <div className="flex gap-2 p-4 bg-gray-50 rounded-lg">
      {levels.map((level) => (
        <button
          key={level.value}
          onClick={() => handleDifficultyChange(level.value)}
          className={cn(
            "px-4 py-2 rounded-md transition-all flex items-center gap-2",
            currentDifficulty === level.value
              ? "bg-blue-500 text-white"
              : "bg-white text-gray-700 hover:bg-gray-100"
          )}
        >
          <span>{level.emoji}</span>
          <span>{level.label}</span>
        </button>
      ))}
    </div>
  );
};
```

#### 3.3.3 議案詳細ページの更新

**`app/bills/[billId]/page.tsx`**

```typescript
import { getDifficultyLevel } from '@/features/bills/actions/difficulty-actions';
import { billsApi } from '@/features/bills/api/bills-api';
import { DifficultySelector } from '@/features/bills/components/difficulty-selector';
import { BillDetailContent } from '@/features/bills/components/bill-detail-content';

export default async function BillDetailPage({
  params,
}: {
  params: { billId: string };
}) {
  // サーバーサイドでCookieから難易度を取得
  const difficulty = await getDifficultyLevel();
  
  // サーバーサイドで議案とコンテンツを取得
  const billWithContent = await billsApi.getBillWithContent(params.billId, difficulty);
  
  if (!billWithContent) {
    return <div>議案が見つかりません</div>;
  }
  
  return (
    <div className="container mx-auto px-4 py-8">
      <DifficultySelector currentDifficulty={difficulty} />
      <BillDetailContent 
        bill={billWithContent} 
        content={billWithContent.bill_contents[0]}
      />
    </div>
  );
}
```

**`features/bills/components/bill-detail-content.tsx`**

```typescript
import { marked } from 'marked';

interface BillDetailContentProps {
  bill: Bill;
  content: BillContent;
}

// サーバーコンポーネントとして実装
export const BillDetailContent: React.FC<BillDetailContentProps> = async ({ 
  bill, 
  content 
}) => {
  // MarkdownをHTMLに変換
  const contentHtml = await marked(content.content);
  
  return (
    <>
      <h1 className="text-3xl font-bold mt-6 mb-4">
        {content.title}
      </h1>

      <div className="bg-blue-50 p-6 rounded-lg mb-6">
        <h2 className="text-xl font-semibold mb-3">要約</h2>
        <p>{content.summary}</p>
      </div>

      <div className="prose max-w-none mb-8">
        <div dangerouslySetInnerHTML={{ __html: contentHtml }} />
      </div>
    </>
  );
};
```

#### 3.3.4 型定義

**`features/bills/types/difficulty.ts`**

```typescript
export type DifficultyLevel = 'easy' | 'normal' | 'hard';

export interface BillContent {
  id: string;
  bill_id: string;
  difficulty_level: DifficultyLevel;
  title: string;
  summary: string;
  content: string; // Markdown形式
  created_at: string;
  updated_at: string;
}
```

### 3.4 フェーズ 4: テスト・調整

#### 3.4.1 単体テスト実装

- Server Actions のテスト
- データアクセス層のテスト
- コンポーネントのテスト

#### 3.4.2 E2E テスト実装

- 難易度切り替えフロー
- Cookie 永続化の確認
- ページ遷移時の設定維持

#### 3.4.3 パフォーマンス最適化

- 切り替え時のレスポンス測定・改善
- バンドルサイズの確認
- 不要な再レンダリングの除去

## 4. ディレクトリ構成

```
mirai-gikai/
├── app/
│   └── bills/
│       └── [billId]/
│           └── page.tsx
├── features/
│   └── bills/
│       ├── actions/
│       │   └── difficulty-actions.ts
│       ├── api/
│       │   └── bills-api.ts
│       ├── components/
│       │   ├── bill-detail-content.tsx
│       │   └── difficulty-selector.tsx
│       └── types/
│           └── difficulty.ts
└── supabase/
    └── migrations/
        └── 20250914_add_bill_contents_table.sql
```

## 5. 実装上の注意点

### 5.1 セキュリティ

- XSS 対策: `dangerouslySetInnerHTML`使用時のサニタイズ
- Cookie のセキュア設定（本番環境）

### 5.2 アクセシビリティ

- 適切な ARIA ラベルの設定
- キーボードナビゲーション対応
- フォーカス管理

### 5.3 SEO

- 各難易度コンテンツの適切なメタタグ設定
- 構造化データの追加

### 5.4 エラーハンドリング

- コンテンツ取得失敗時のフォールバック
- ネットワークエラー時の再試行処理

## 6. デプロイメント計画

### 6.1 環境別対応

- **開発環境**: ローカル Supabase 使用
- **ステージング環境**: テスト用データで動作確認
- **本番環境**: 段階的ロールアウト

### 6.2 リリース手順

1. データベースマイグレーション実行
2. API デプロイ
3. フロントエンドデプロイ
4. 動作確認
5. モニタリング

## 7. 今後の改善案

### 7.1 短期的改善

- プリフェッチによるパフォーマンス向上
- モバイル UI の最適化
- ローディング状態の改善

### 7.2 中長期的改善

- AI による自動コンテンツ生成
- ユーザーの理解度に応じた動的難易度調整
- 音声読み上げ機能の追加
