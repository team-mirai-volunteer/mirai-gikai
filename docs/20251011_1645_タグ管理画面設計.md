# タグ管理画面設計

## 概要

議案に付与するタグを管理するための管理画面。
タグの追加・編集・削除、および各タグに紐付く議案数の確認を1画面で完結させる。

## 要件

### 機能要件

1. **タグの追加**
   - ラベル名を入力して新規タグを作成
   - ラベル名は重複不可（DB制約により保証）
   - 重複時はエラーメッセージを表示

2. **タグの編集**
   - 既存タグのラベル名を画面内で直接編集可能
   - インライン編集（クリックで編集モードに切り替え）

3. **タグの削除**
   - 削除ボタンクリック時に確認ダイアログを表示
   - 確認メッセージ: 「このタグを削除しますか？紐付けられている議案からもタグが削除されます。」
   - 削除するとそのタグが付いている議案との紐付けも削除される（CASCADE）

4. **タグ一覧表示**
   - 全タグを一覧表示
   - 各タグには紐付いている議案の件数を表示
   - 表示順: 作成日時の昇順（古い順）

5. **検索機能**
   - 現時点では不要（将来的に拡張可能）

### 非機能要件

- レスポンシブデザイン（モバイル・タブレット・デスクトップ対応）
- アクセス権限: 管理者のみアクセス可能
- リアルタイム更新は不要（手動リフレッシュ）

## 画面レイアウト

```
┌─────────────────────────────────────────────┐
│ タグ管理                                     │
├─────────────────────────────────────────────┤
│                                             │
│ [タグ追加セクション]                          │
│ ┌─────────────────────────────────────┐     │
│ │ タグ名: [_______________] [追加]    │     │
│ └─────────────────────────────────────┘     │
│                                             │
│ [タグ一覧セクション]                          │
│ ┌─────────────────────────────────────┐     │
│ │ タグ一覧 (5件)                       │     │
│ ├─────────────────────────────────────┤     │
│ │ □ 重要     [編集] [削除]  (3件)     │     │
│ │ □ 経済     [編集] [削除]  (7件)     │     │
│ │ □ 教育     [編集] [削除]  (2件)     │     │
│ │ □ 環境     [編集] [削除]  (0件)     │     │
│ │ □ 福祉     [編集] [削除]  (5件)     │     │
│ └─────────────────────────────────────┘     │
└─────────────────────────────────────────────┘
```

### UIコンポーネント構成

1. **タグ追加フォーム（上部）**
   - ラベル: "タグ名"
   - テキストインプット（必須）
   - 追加ボタン
   - バリデーションエラー表示エリア

2. **タグ一覧（下部）**
   - ヘッダー: "タグ一覧 (n件)"
   - タグアイテム（リスト形式）
     - タグラベル（編集可能）
     - 編集ボタン（インライン編集用）
     - 削除ボタン
     - 議案件数バッジ "(n件)"

## API設計

### 1. タグ一覧取得

**エンドポイント**: `GET /api/admin/tags`

**レスポンス**:
```typescript
{
  tags: Array<{
    id: string
    label: string
    created_at: string
    updated_at: string
    bill_count: number  // 紐付いている議案の数
  }>
}
```

**クエリ**:
```sql
SELECT
  tags.id,
  tags.label,
  tags.created_at,
  tags.updated_at,
  COUNT(bills_tags.bill_id) as bill_count
FROM tags
LEFT JOIN bills_tags ON tags.id = bills_tags.tag_id
GROUP BY tags.id
ORDER BY tags.created_at ASC
```

### 2. タグ追加

**エンドポイント**: `POST /api/admin/tags`

**リクエスト**:
```typescript
{
  label: string  // 必須、1文字以上
}
```

**レスポンス**:
```typescript
{
  tag: {
    id: string
    label: string
    created_at: string
    updated_at: string
  }
}
```

**エラーレスポンス**:
- 400: ラベルが空
- 409: 同じラベルが既に存在（UNIQUE制約違反）

### 3. タグ編集

**エンドポイント**: `PATCH /api/admin/tags/[id]`

**リクエスト**:
```typescript
{
  label: string  // 必須、1文字以上
}
```

**レスポンス**:
```typescript
{
  tag: {
    id: string
    label: string
    created_at: string
    updated_at: string
  }
}
```

**エラーレスポンス**:
- 400: ラベルが空
- 404: タグが存在しない
- 409: 同じラベルが既に存在（UNIQUE制約違反）

### 4. タグ削除

**エンドポイント**: `DELETE /api/admin/tags/[id]`

**レスポンス**:
```typescript
{
  success: true
}
```

**エラーレスポンス**:
- 404: タグが存在しない

**注意**: `bills_tags` テーブルの `ON DELETE CASCADE` により、紐付いている議案との関連も自動削除される

## ディレクトリ構造

Next.jsの feature ベースアーキテクチャに従う。

```
admin/src/features/tags/
├── components/
│   ├── tag-form.tsx           # タグ追加フォーム
│   ├── tag-list.tsx           # タグ一覧
│   └── tag-item.tsx           # タグ個別アイテム（編集・削除機能）
├── actions/
│   ├── create-tag.ts          # タグ作成 Server Action
│   ├── update-tag.ts          # タグ編集 Server Action
│   └── delete-tag.ts          # タグ削除 Server Action
├── api/
│   └── get-tags.ts            # タグ一覧取得（議案数含む）
└── types/
    └── index.ts               # Tag型定義

admin/src/app/(authenticated)/tags/
└── page.tsx                   # タグ管理画面ページ
```

## 型定義

```typescript
// admin/src/features/tags/types/index.ts

export type Tag = {
  id: string
  label: string
  created_at: string
  updated_at: string
}

export type TagWithBillCount = Tag & {
  bill_count: number
}

export type CreateTagInput = {
  label: string
}

export type UpdateTagInput = {
  label: string
}
```

## コンポーネント詳細設計

### 1. TagForm コンポーネント

**責務**: タグの新規追加

**Props**: なし

**状態**:
- `label`: string (入力中のラベル)
- `isSubmitting`: boolean (送信中フラグ)
- `error`: string | null (エラーメッセージ)

**動作**:
1. ユーザーがラベルを入力
2. 「追加」ボタンクリック
3. `createTag` Server Action を呼び出し
4. 成功: フォームをクリア、一覧を再取得（revalidatePath）
5. 失敗: エラーメッセージを表示

### 2. TagList コンポーネント

**責務**: タグ一覧の表示

**Props**:
```typescript
{
  tags: TagWithBillCount[]
}
```

**動作**:
- タグの配列を受け取り、TagItem を繰り返し表示
- 件数を表示（「タグ一覧 (n件)」）

### 3. TagItem コンポーネント

**責務**: 個別タグの表示・編集・削除

**Props**:
```typescript
{
  tag: TagWithBillCount
}
```

**状態**:
- `isEditing`: boolean (編集モードフラグ)
- `editLabel`: string (編集中のラベル)
- `isSubmitting`: boolean (送信中フラグ)

**動作**:

**編集機能**:
1. ラベルをクリックまたは「編集」ボタンクリック
2. 編集モードに切り替え（インプットフィールド表示）
3. ユーザーがラベルを変更
4. Enterキーまたは保存ボタンで `updateTag` Server Action を呼び出し
5. 成功: 編集モード解除、一覧を再取得
6. 失敗: エラーメッセージ表示

**削除機能**:
1. 「削除」ボタンクリック
2. 確認ダイアログ表示: 「このタグを削除しますか？紐付けられている議案からもタグが削除されます。」
3. ユーザーが確認
4. `deleteTag` Server Action を呼び出し
5. 成功: 一覧から削除、一覧を再取得
6. 失敗: エラーメッセージ表示

## Server Actions 詳細設計

### 1. createTag

```typescript
// admin/src/features/tags/actions/create-tag.ts

'use server'

import { revalidatePath } from 'next/cache'
import { createAdminClient } from '@/lib/supabase/server'

export async function createTag(input: { label: string }) {
  const supabase = createAdminClient()

  // バリデーション
  if (!input.label || input.label.trim().length === 0) {
    return { error: 'タグ名を入力してください' }
  }

  const { data, error } = await supabase
    .from('tags')
    .insert({ label: input.label.trim() })
    .select()
    .single()

  if (error) {
    // UNIQUE制約違反
    if (error.code === '23505') {
      return { error: 'このタグ名は既に存在します' }
    }
    return { error: 'タグの作成に失敗しました' }
  }

  revalidatePath('/tags')
  return { data }
}
```

### 2. updateTag

```typescript
// admin/src/features/tags/actions/update-tag.ts

'use server'

import { revalidatePath } from 'next/cache'
import { createAdminClient } from '@/lib/supabase/server'

export async function updateTag(id: string, input: { label: string }) {
  const supabase = createAdminClient()

  // バリデーション
  if (!input.label || input.label.trim().length === 0) {
    return { error: 'タグ名を入力してください' }
  }

  const { data, error } = await supabase
    .from('tags')
    .update({ label: input.label.trim() })
    .eq('id', id)
    .select()
    .single()

  if (error) {
    // UNIQUE制約違反
    if (error.code === '23505') {
      return { error: 'このタグ名は既に存在します' }
    }
    // レコードが見つからない
    if (error.code === 'PGRST116') {
      return { error: 'タグが見つかりません' }
    }
    return { error: 'タグの更新に失敗しました' }
  }

  revalidatePath('/tags')
  return { data }
}
```

### 3. deleteTag

```typescript
// admin/src/features/tags/actions/delete-tag.ts

'use server'

import { revalidatePath } from 'next/cache'
import { createAdminClient } from '@/lib/supabase/server'

export async function deleteTag(id: string) {
  const supabase = createAdminClient()

  const { error } = await supabase
    .from('tags')
    .delete()
    .eq('id', id)

  if (error) {
    // レコードが見つからない
    if (error.code === 'PGRST116') {
      return { error: 'タグが見つかりません' }
    }
    return { error: 'タグの削除に失敗しました' }
  }

  revalidatePath('/tags')
  return { success: true }
}
```

## API関数 詳細設計

### getTags

```typescript
// admin/src/features/tags/api/get-tags.ts

import { createAdminClient } from '@/lib/supabase/server'
import type { TagWithBillCount } from '../types'

export async function getTags(): Promise<TagWithBillCount[]> {
  const supabase = createAdminClient()

  // Supabase クエリで議案数をカウント
  const { data, error } = await supabase
    .from('tags')
    .select(`
      id,
      label,
      created_at,
      updated_at,
      bills_tags(count)
    `)
    .order('created_at', { ascending: true })

  if (error) {
    throw new Error('タグの取得に失敗しました')
  }

  // データを整形
  return data.map(tag => ({
    id: tag.id,
    label: tag.label,
    created_at: tag.created_at,
    updated_at: tag.updated_at,
    bill_count: tag.bills_tags[0]?.count || 0
  }))
}
```

## ページコンポーネント設計

```typescript
// admin/src/app/(authenticated)/tags/page.tsx

import { getTags } from '@/features/tags/api/get-tags'
import { TagForm } from '@/features/tags/components/tag-form'
import { TagList } from '@/features/tags/components/tag-list'

export default async function TagsPage() {
  const tags = await getTags()

  return (
    <div className="container mx-auto py-8">
      <h1 className="text-2xl font-bold mb-8">タグ管理</h1>

      {/* タグ追加セクション */}
      <section className="mb-8">
        <TagForm />
      </section>

      {/* タグ一覧セクション */}
      <section>
        <TagList tags={tags} />
      </section>
    </div>
  )
}
```

## エラーハンドリング

### クライアント側

- フォームバリデーションエラー: インラインでエラーメッセージ表示
- Server Action エラー: トースト通知またはインラインエラー表示
- ネットワークエラー: エラーバウンダリーでキャッチ

### サーバー側

- DB制約違反（UNIQUE制約）: 409エラー、ユーザーフレンドリーなメッセージ
- レコード未検出: 404エラー
- その他のDBエラー: 500エラー、汎用エラーメッセージ

## セキュリティ考慮事項

1. **認証**: 管理画面なので、認証ミドルウェアで保護
2. **認可**: 管理者権限のチェック（`is_admin()` 関数）
3. **入力バリデーション**:
   - ラベルの空文字チェック
   - ラベルの最大長チェック（必要に応じて）
   - XSS対策（React が自動エスケープ）
4. **SQLインジェクション対策**: Supabase クライアントがパラメータ化クエリを使用
5. **CSRF対策**: Next.js の Server Actions が自動的に対策

## 将来的な拡張案

現時点では実装しないが、将来的に検討可能な機能：

1. **タグの色設定**: タグに色を付けて視覚的に区別
2. **タグのカテゴリー**: タグをカテゴリー分け
3. **タグの並び替え**: ドラッグ&ドロップで並び順を変更
4. **タグの検索**: タグ数が増えた場合の検索機能
5. **一括操作**: 複数タグの一括削除
6. **使用状況の詳細**: タグをクリックすると紐付いている議案一覧を表示
7. **タグの統合**: 複数のタグを1つに統合する機能
8. **タグの使用頻度分析**: タグの使用傾向を可視化

## テスト項目

### 単体テスト

- [ ] Server Actions のバリデーション
- [ ] Server Actions のエラーハンドリング
- [ ] API関数のデータ取得

### 統合テスト

- [ ] タグの追加フロー
- [ ] タグの編集フロー
- [ ] タグの削除フロー
- [ ] UNIQUE制約違反時のエラー表示

### E2Eテスト

- [ ] タグ管理画面の表示
- [ ] タグの追加
- [ ] タグの編集（インライン）
- [ ] タグの削除（確認ダイアログ含む）
- [ ] 議案件数の表示

## 実装手順

1. 型定義の作成
2. API関数の実装（getTags）
3. Server Actionsの実装（create/update/delete）
4. コンポーネントの実装
   - TagForm
   - TagList
   - TagItem
5. ページの実装
6. スタイリング
7. エラーハンドリングの強化
8. テストの追加

## 参考UI

shadcn/ui コンポーネントを使用:
- Form: タグ追加フォーム
- Input: ラベル入力
- Button: 追加・編集・削除ボタン
- Card: タグアイテム
- AlertDialog: 削除確認ダイアログ
- Badge: 議案件数バッジ
- toast: 成功・エラー通知
