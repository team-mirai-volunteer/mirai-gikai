# 法案インタビュー機能 DB設計

## 概要

AIがユーザーに法案について質問を投げかけるインタビュー機能のデータベース設計。
インタビュー設定、事前定義質問、セッション、メッセージ履歴、レポートのテーブルを定義します。

## テーブル設計

### 1. interview_configs テーブル

議案ごとのインタビュー設定を管理するテーブル。1議案1設定。

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY, DEFAULT gen_random_uuid() | 設定ID |
| bill_id | UUID | NOT NULL, UNIQUE, REFERENCES bills(id) ON DELETE CASCADE | 対象議案ID |
| status | interview_config_status_enum | NOT NULL, DEFAULT 'closed' | 設定ステータス |
| themes | TEXT[] | NULL | テーマの配列 |
| knowledge_source | TEXT | NULL | 議案のコンテキスト情報 |
| created_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT NOW() | 更新日時 |

**ENUM型**: `interview_config_status_enum`
- `public`: 公開（インタビュー機能が有効）
- `closed`: 非公開（インタビュー機能が無効）

### 2. interview_questions テーブル

事前定義されたインタビュー質問を管理するテーブル。

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY, DEFAULT gen_random_uuid() | 質問ID |
| interview_config_id | UUID | NOT NULL, REFERENCES interview_configs(id) ON DELETE CASCADE | インタビュー設定ID |
| question | TEXT | NOT NULL | 質問文 |
| instruction | TEXT | NULL | AIへの指示（質問の深掘り方法など） |
| quick_replies | TEXT[] | NULL | ユーザーが選択できるクイックリプライ |
| question_order | INTEGER | NOT NULL | 質問の順序 |
| created_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT NOW() | 更新日時 |

### 3. interview_sessions テーブル

インタビューセッションを管理するテーブル。1ユーザーは1議案につき複数セッション可能。

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY, DEFAULT gen_random_uuid() | セッションID |
| interview_config_id | UUID | NOT NULL, REFERENCES interview_configs(id) ON DELETE CASCADE | インタビュー設定ID |
| user_id | UUID | NOT NULL | ユーザーID（匿名認証） |
| langfuse_session_id | TEXT | NULL | LangfuseセッションID |
| started_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT NOW() | 開始日時 |
| completed_at | TIMESTAMP WITH TIME ZONE | NULL | 完了日時 |
| created_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT NOW() | 更新日時 |

### 4. interview_messages テーブル

インタビュー内の質問と回答を保存するテーブル。

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY, DEFAULT gen_random_uuid() | メッセージID |
| interview_session_id | UUID | NOT NULL, REFERENCES interview_sessions(id) ON DELETE CASCADE | インタビューセッションID |
| role | interview_role_enum | NOT NULL | メッセージの役割 |
| content | TEXT | NOT NULL | メッセージ内容 |
| created_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT NOW() | 作成日時 |

**ENUM型**: `interview_role_enum`
- `assistant`: AIからの質問
- `user`: ユーザーからの回答

### 5. interview_report テーブル

インタビュー結果のレポートを保存するテーブル。AIが自動生成。

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY, DEFAULT gen_random_uuid() | レポートID |
| interview_session_id | UUID | NOT NULL, UNIQUE, REFERENCES interview_sessions(id) ON DELETE CASCADE | インタビューセッションID |
| summary | TEXT | NULL | インタビュー要約 |
| stance | stance_type_enum | NULL | AIが分析したユーザーのスタンス |
| role | TEXT | NULL | AIが推論したユーザーの役割 |
| role_description | TEXT | NULL | 役割の説明 |
| opinions | JSONB | NULL | 意見の配列 `[{title: string, content: string}, ...]` |
| created_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | NOT NULL, DEFAULT NOW() | 更新日時 |

**既存ENUM型**: `stance_type_enum` (billsテーブルで定義済み)
- `for`: 賛成
- `against`: 反対
- `neutral`: 中立

## データ制約

### インデックス

**interview_configs テーブル**:
- `idx_interview_configs_bill_id`: bill_id での検索（UNIQUE制約で自動生成）
- `idx_interview_configs_status`: status での検索

**interview_questions テーブル**:
- `idx_interview_questions_config_id`: interview_config_id での検索
- `idx_interview_questions_config_order`: (interview_config_id, question_order) での順序検索

**interview_sessions テーブル**:
- `idx_interview_sessions_config_id`: interview_config_id での検索
- `idx_interview_sessions_user_id`: user_id での検索
- `idx_interview_sessions_config_user`: (interview_config_id, user_id) での検索
- `idx_interview_sessions_started_at`: started_at での時系列検索

**interview_messages テーブル**:
- `idx_interview_messages_session_id`: interview_session_id での検索
- `idx_interview_messages_session_created`: (interview_session_id, created_at) での時系列検索

**interview_report テーブル**:
- `idx_interview_report_session_id`: interview_session_id での検索（UNIQUE制約で自動生成）

### 削除時の動作

- **議案削除時**: `interview_configs` のレコードが `ON DELETE CASCADE` で削除され、関連する `interview_questions`, `interview_sessions` も自動削除
- **インタビュー設定削除時**: `interview_questions` のレコードが `ON DELETE CASCADE` で削除
- **インタビューセッション削除時**: `interview_messages`, `interview_report` のレコードが `ON DELETE CASCADE` で削除

## RLSポリシー

既存のテーブルと同様に、RLSは有効化するがポリシーは設定しない（デフォルト拒否）。
アクセスはSupabase Service Role経由で行う想定。

- `interview_configs`: RLS ON, ポリシーなし
- `interview_questions`: RLS ON, ポリシーなし
- `interview_sessions`: RLS ON, ポリシーなし
- `interview_messages`: RLS ON, ポリシーなし
- `interview_report`: RLS ON, ポリシーなし

## マイグレーションファイル

`supabase/migrations/20251217183119_create_interview_tables.sql`

## 設計のポイント

1. **設定と質問の分離**: 議案ごとの設定と質問を分離し、柔軟な管理を可能に
2. **複数セッション対応**: 1ユーザーが1議案につき複数のインタビューセッションを作成可能
3. **事前定義質問**: 質問を事前に定義し、AIがそれを使用してインタビューを進行
4. **レポート自動生成**: インタビュー完了時にAIが自動でレポートを生成
5. **Langfuse連携**: LangfuseセッションIDを保存し、デバッグや分析を容易に
6. **クイックリプライ**: ユーザーが選択できるクイックリプライでUX向上

## 使用例（参考）

### インタビュー設定の作成

```sql
INSERT INTO interview_configs (bill_id, status, themes, knowledge_source)
VALUES (
  'bill-uuid',
  'public',
  ARRAY['経済', '環境', '社会'],
  '議案の要約と詳細内容...'
);
```

### 質問の追加

```sql
INSERT INTO interview_questions (interview_config_id, question, instruction, quick_replies, question_order)
VALUES (
  'config-uuid',
  'この議案についてどう思いますか？',
  'ユーザーの回答に基づいて深掘り質問を生成する',
  ARRAY['賛成', '反対', 'どちらとも言えない'],
  1
);
```

### セッションの作成

```sql
INSERT INTO interview_sessions (interview_config_id, user_id, langfuse_session_id)
VALUES ('config-uuid', 'user-uuid', 'langfuse-session-id');
```

### レポートの作成

```sql
INSERT INTO interview_report (
  interview_session_id,
  summary,
  stance,
  role,
  role_description,
  opinions
)
VALUES (
  'session-uuid',
  'インタビュー要約...',
  'for',
  '学生',
  '大学生で環境問題に関心が高い',
  '[
    {"title": "環境への影響", "content": "環境への影響を重視している"},
    {"title": "経済効果", "content": "経済効果も期待している"}
  ]'::jsonb
);
```

## 実装手順

### 1. マイグレーションの適用

```bash
# ローカル環境でマイグレーションを適用
supabase db reset

# または本番環境にプッシュ
supabase db push
```

### 2. 型定義の再生成

```bash
# ローカル環境から型定義を生成
supabase gen types typescript --local > packages/supabase/types/supabase.types.ts
```

### 3. 動作確認

- テーブルが正しく作成されているか確認
- インデックスが作成されているか確認
- トリガーが設定されているか確認
- RLSが有効になっているか確認

