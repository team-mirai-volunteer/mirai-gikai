# AI チャット機能 実装計画書

## 1. 実装フェーズ

### Phase 1: 環境構築とパッケージインストール

- Vercel AI SDK 関連パッケージのインストール
- AI SDK Elements UI のセットアップ
- Streamdown のインストール
- OpenAI API キーの設定

### Phase 2: API 実装

- チャット API エンドポイントの作成
- OpenAI 統合とプロンプト設計
- ストリーミングレスポンスの実装
- Vercel AI Gateway 設定（オプション）

### Phase 3: UI 実装

- AI SDK Elements を使用したチャットコンポーネント作成
- フローティングボタンの実装
- レスポンシブデザインの適用
- Streamdown によるマークダウンレンダリング

### Phase 4: 統合とテスト

- 議案詳細ページへの組み込み
- 議案コンテキストの受け渡し
- エラーハンドリング
- 動作確認とバグ修正

## 2. 詳細実装計画

### 2.1 パッケージインストール

```bash
# web/ディレクトリで実行
# Core AI SDK (最新安定版 v5)
pnpm add ai @ai-sdk/react

# AI Elements (コンポーネントライブラリ)
npx ai-elements@latest

# Streamdown
pnpm add streamdown
```

### 2.2 環境変数設定

`.env`に追加:

```env
# Vercel AI Gateway API Key (Vercel Dashboardから取得)
AI_GATEWAY_API_KEY=your-ai-gateway-api-key
```

### 2.3 ディレクトリ構造

```
web/src/
├── features/
│   └── chat/
│       ├── components/
│       │   ├── chat-button.tsx
│       │   ├── chat-window.tsx
│       │   ├── chat-messages.tsx
│       │   └── index.ts
│       ├── hooks/
│       │   └── use-chat.ts
│       └── types/
│           └── index.ts
└── app/
    └── api/
        └── chat/
            └── route.ts
```

### 2.4 実装詳細

#### API 実装 (`app/api/chat/route.ts`)

```typescript
import { streamText } from "ai";

export async function POST(req: Request) {
  const { messages, billContext } = await req.json();

  const systemPrompt = `
    あなたは日本の議案について説明する専門的なアシスタントです。
    
    議案情報：
    - 名称: ${billContext.name}
    - 説明: ${billContext.description || ""}
    - 詳細: ${billContext.content || ""}
    - チームみらいのスタンス: ${billContext.miraiStance?.position || ""} 
      理由: ${billContext.miraiStance?.reason || ""}
    
    ルール：
    1. この議案に関する質問にのみ回答する
    2. 分かりやすく簡潔に説明する
    3. 専門用語は必要に応じて解説する
    4. 議案と無関係の質問には「申し訳ございません。この議案に関する質問にお答えします」と返答する
  `;

  // Vercel AI Gatewayを通じて直接モデルを指定
  const result = streamText({
    model: "openai/gpt-5", // プロバイダー/モデル形式で指定
    system: systemPrompt,
    messages,
    // API Keyは環境変数から自動的に読み込まれる
    apiKey: process.env.AI_GATEWAY_API_KEY,
  });

  return result.toDataStreamResponse();
}
```

#### チャットボタン (`features/chat/components/chat-button.tsx`)

```typescript
"use client";

import { MessageCircle } from "lucide-react";
import { useState } from "react";
import { ChatWindow } from "./chat-window";

interface ChatButtonProps {
  billContext: {
    id: string;
    name: string;
    description?: string;
    content?: string;
    miraiStance?: {
      position: string;
      reason: string;
    };
  };
}

export function ChatButton({ billContext }: ChatButtonProps) {
  const [isOpen, setIsOpen] = useState(false);

  return (
    <>
      <button
        onClick={() => setIsOpen(true)}
        className="fixed bottom-4 right-4 z-50 rounded-full bg-primary p-4 text-white shadow-lg hover:bg-primary/90 transition-colors md:bottom-8 md:right-8"
        aria-label="議案について質問する"
      >
        <MessageCircle className="h-6 w-6" />
      </button>

      {isOpen && (
        <ChatWindow
          billContext={billContext}
          onClose={() => setIsOpen(false)}
        />
      )}
    </>
  );
}
```

#### チャットウィンドウ (`features/chat/components/chat-window.tsx`)

```typescript
"use client";

import { useChat } from "ai/react";
import { X } from "lucide-react";
import { StreamdownMessage } from "./streamdown-message";
// AI Elementsのコンポーネントを使用
import { Conversation } from "@/components/ai/conversation";
import { Message } from "@/components/ai/message";
import { PromptInput } from "@/components/ai/prompt-input";
import { Loader } from "@/components/ai/loader";

interface ChatWindowProps {
  billContext: any;
  onClose: () => void;
}

export function ChatWindow({ billContext, onClose }: ChatWindowProps) {
  const { messages, input, handleInputChange, handleSubmit, isLoading } =
    useChat({
      api: "/api/chat",
      body: {
        billContext,
      },
      initialMessages: [
        {
          id: "welcome",
          role: "assistant",
          content: `こんにちは！「${billContext.name}」について、ご質問はありませんか？

例えば、以下のような質問にお答えできます：
- この議案の目的は何ですか？
- どのような影響がありますか？
- みらいはなぜこのスタンスを取っているのですか？

お気軽にご質問ください。`,
        },
      ],
    });

  return (
    <div className="fixed inset-x-0 bottom-0 z-50 h-[70vh] bg-background shadow-xl md:bottom-4 md:right-4 md:left-auto md:h-[600px] md:w-[400px] md:rounded-lg flex flex-col">
      {/* ヘッダー */}
      <div className="flex items-center justify-between border-b p-4">
        <h2 className="text-lg font-semibold">議案について質問する</h2>
        <button
          onClick={onClose}
          className="rounded-full p-1 hover:bg-gray-100"
          aria-label="閉じる"
        >
          <X className="h-5 w-5" />
        </button>
      </div>

      {/* メッセージエリア */}
      <Conversation className="flex-1 overflow-y-auto p-4">
        {messages.map((message) => (
          <Message
            key={message.id}
            role={message.role}
            className={`mb-4 ${
              message.role === "user" ? "justify-end" : "justify-start"
            }`}
          >
            {message.role === "assistant" ? (
              <StreamdownMessage content={message.content} />
            ) : (
              message.content
            )}
          </Message>
        ))}
        {isLoading && <Loader />}
      </Conversation>

      {/* 入力エリア */}
      <div className="border-t p-4">
        <PromptInput
          value={input}
          onChange={handleInputChange}
          onSubmit={handleSubmit}
          placeholder="質問を入力してください..."
          disabled={isLoading}
        />
      </div>
    </div>
  );
}
```

#### Streamdown メッセージコンポーネント (`features/chat/components/streamdown-message.tsx`)

```typescript
"use client";

import { Streamdown } from "streamdown";

interface StreamdownMessageProps {
  content: string;
}

export function StreamdownMessage({ content }: StreamdownMessageProps) {
  return (
    <Streamdown
      content={content}
      components={{
        // カスタムコンポーネントの定義（必要に応じて）
        Code: ({ children, ...props }) => (
          <code className="rounded bg-gray-200 px-1 py-0.5" {...props}>
            {children}
          </code>
        ),
        Pre: ({ children, ...props }) => (
          <pre className="overflow-x-auto rounded bg-gray-200 p-2" {...props}>
            {children}
          </pre>
        ),
      }}
    />
  );
}
```

#### 議案詳細ページへの統合 (`app/bills/[id]/page.tsx`)

```typescript
import { ChatButton } from "@/features/chat/components";

export default async function BillDetailPage({ params }: BillDetailPageProps) {
  const { id } = await params;
  const billWithStance = await getBillById(id);

  if (!billWithStance) {
    notFound();
  }

  const billContext = {
    id: billWithStance.id,
    name: billWithStance.name,
    description: billWithStance.description,
    content: billWithStance.content,
    miraiStance: billWithStance.mirai_stance,
  };

  return (
    <>
      <BillDetailLayout bill={billWithStance} />
      <ChatButton billContext={billContext} />
    </>
  );
}
```

## 3. テスト計画

### 3.1 単体テスト

- API エンドポイントのテスト
- コンポーネントのレンダリングテスト
- フック関数のテスト

### 3.2 統合テスト

- チャットフローの E2E テスト
- エラーハンドリングのテスト
- レスポンシブデザインのテスト

### 3.3 手動テスト項目

- [ ] チャットボタンのクリックでウィンドウが開く
- [ ] 初期メッセージが表示される
- [ ] 質問を送信できる
- [ ] AI の回答がストリーミング表示される
- [ ] マークダウンが正しくレンダリングされる
- [ ] 議案に関係ない質問を適切に断る
- [ ] モバイルでの表示が適切
- [ ] デスクトップでの表示が適切
- [ ] ウィンドウを閉じることができる
- [ ] エラー時に適切なメッセージが表示される

## 4. 実装スケジュール

1. **Phase 1**: 30 分

   - パッケージインストール
   - 環境変数設定

2. **Phase 2**: 1 時間

   - API エンドポイント実装
   - プロンプト調整

3. **Phase 3**: 2 時間

   - UI コンポーネント実装
   - スタイリング調整

4. **Phase 4**: 1 時間
   - 統合作業
   - テスト・デバッグ

**合計見積もり時間**: 約 4.5 時間

## 5. 注意事項

- AI SDK Elements の最新ドキュメントを参照しながら実装
- Streamdown の設定は公式ドキュメントに従う
- Vercel AI Gateway API キーは環境変数で管理（コミットしない）
- Vercel Dashboard から AI Gateway API キーを取得する必要がある
- AI SDK v5 (安定版) で Vercel AI Gateway に対応
- エラーハンドリングを適切に実装
- レート制限は初期実装では考慮しないが、将来的な拡張を考慮した設計にする

## 6. 参考リンク

- [Vercel AI SDK Documentation](https://sdk.vercel.ai/docs)
- [AI SDK Elements](https://ai-sdk.dev/elements/overview)
- [Streamdown](https://github.com/streamdown/streamdown)
- [Vercel AI Gateway](https://vercel.com/docs/ai/ai-gateway)
